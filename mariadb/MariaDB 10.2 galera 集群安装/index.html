<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="环境:每台服务器安装CentOS 7.2 Minimal 版本，安装后使用yum update更新一下最新的系统内核和相关配置参数。  MariaDB galera集群建议最少3台服务器，2台无法保证数据完整性。  几台虚拟机ip设置如下：  节点名称   IP地址 cluster1    192.168.56.21 cluster2    192.168.56.22 cluster3    19">
<meta name="keywords" content="mariadb,mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="MariaDB 10.2 galera 集群安装">
<meta property="og:url" content="http://dolphincn.github.io/mariadb/MariaDB 10.2 galera 集群安装/index.html">
<meta property="og:site_name" content="克隆人战争">
<meta property="og:description" content="环境:每台服务器安装CentOS 7.2 Minimal 版本，安装后使用yum update更新一下最新的系统内核和相关配置参数。  MariaDB galera集群建议最少3台服务器，2台无法保证数据完整性。  几台虚拟机ip设置如下：  节点名称   IP地址 cluster1    192.168.56.21 cluster2    192.168.56.22 cluster3    19">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-06-22T06:30:31.412Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MariaDB 10.2 galera 集群安装">
<meta name="twitter:description" content="环境:每台服务器安装CentOS 7.2 Minimal 版本，安装后使用yum update更新一下最新的系统内核和相关配置参数。  MariaDB galera集群建议最少3台服务器，2台无法保证数据完整性。  几台虚拟机ip设置如下：  节点名称   IP地址 cluster1    192.168.56.21 cluster2    192.168.56.22 cluster3    19">






  <link rel="canonical" href="http://dolphincn.github.io/mariadb/MariaDB 10.2 galera 集群安装/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>MariaDB 10.2 galera 集群安装 | 克隆人战争</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">克隆人战争</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">为了生存, 为了私利,<br/>争斗才是人类历史的主旋律！</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dolphincn.github.io/mariadb/MariaDB 10.2 galera 集群安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dolphin">
      <meta itemprop="description" content="现实是强者理想的实现">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="克隆人战争">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MariaDB 10.2 galera 集群安装
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-06-17 17:48:28" itemprop="dateCreated datePublished" datetime="2018-06-17T17:48:28+08:00">2018-06-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-06-22 14:30:31" itemprop="dateModified" datetime="2018-06-22T14:30:31+08:00">2018-06-22</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/mariadb/" itemprop="url" rel="index"><span itemprop="name">mariadb</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/mariadb/install/" itemprop="url" rel="index"><span itemprop="name">install</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="环境"><a href="#环境" class="headerlink" title="环境:"></a>环境:</h2><pre><code>每台服务器安装CentOS 7.2 Minimal 版本，安装后使用yum update更新一下最新的系统内核和相关配置参数。

MariaDB galera集群建议最少3台服务器，2台无法保证数据完整性。

几台虚拟机ip设置如下：

节点名称   IP地址
cluster1    192.168.56.21
cluster2    192.168.56.22
cluster3    192.168.56.23

删除CentOS自带的老版本mariadb lib文件

查找安装的mariadb
sudo rpm -qa | grep mariadb

删除查找到的lib文件
sudo rpm -e --nodeps (这里是查找到的mariadb lib 文件)
</code></pre><a id="more"></a>
<h2 id="安全设置"><a href="#安全设置" class="headerlink" title="安全设置"></a>安全设置</h2><pre><code>1) firewall

    因为安装mariadb galera 需要打开 3306、4444、4567、4568四个端口，而且要降低安全审核级别。

    使用以下命令设置防火墙开放这几个端口：

    3306是MariaDB/mysql的服务端口，这个都不开那就不用跑MariaDB/MySQL服务了，需要开TCP端口；
    4567是Galera做数据复制的通讯和数据传输端口，需要在防火墙放开TCP和UDP；
    4568是Galera做增量数据传输使用的端口（Incremental State Transfer, IST），需要防火墙放开TCP；
    4444是Galera做快照状态传输使用的端口（State Snapshot Transfer, SST），需要防火墙放开TCP。）

    sudo firewall-cmd --permanent --zone=public --add-port={3306,4567,4568,4444}/tcp
    sudo firewall-cmd --permanent --zone=public --add-port=4567/udp
    sudo firewall-cmd --reload （重新加载防火墙使修改生效）

2) selinux

    在CentOS的SELinux配置文件中降低SELinux的安全审核级别，让mysqld可以正常运行，否则SELinux会限制集群数据传输
    (setenforce 0 命令只能设置运行时的安全级别，想要完全设置安全级别，需要在SELinux的配置文件中进行配置更改)

    使用vi 打开/etc/selinux/config配置文件，设置SELINUX=permissive 
    sudo vi /etc/selinux/config

    或者键入命令 semanage permissive -a mysqld_t

    使用reboot命令重启服务器使SELinux安全级别更改生效
</code></pre><h2 id="配置-yum源"><a href="#配置-yum源" class="headerlink" title="配置 yum源"></a>配置 yum源</h2><pre><code>1) 配置 mariadb 10.2 yum源

    官网地址 https://downloads.mariadb.org/

    选择最新稳定版本 MariaDB Galera Cluster 10.2 Series

    (原有下载地址太慢，需要换成国内的镜像地址)
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	cat &gt; /etc/yum.repos.d/mariadb.repo &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[mariadb]</span><br><span class="line"></span><br><span class="line">name = MariaDB-10.2</span><br><span class="line"></span><br><span class="line">baseurl = http://yum.mariadb.org/10.2/centos7-amd64/</span><br><span class="line">gpgkey = https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line"></span><br><span class="line"><span class="comment">#baseurl = http://mirrors.ustc.edu.cn/mariadb/yum/10.2/centos7-amd64/</span></span><br><span class="line"><span class="comment">#gpgkey = https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB</span></span><br><span class="line"></span><br><span class="line">enabled = 1</span><br><span class="line">gpgcheck = 1</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<pre><code>2) 配置 percona yum源
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	cat &gt; /etc/yum.repos.d/percona.repo &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[percona-release-<span class="variable">$basearch</span>]</span><br><span class="line">name = Percona-Release YUM repository - <span class="variable">$basearch</span></span><br><span class="line">baseurl = http://repo.percona.com/release/7Server/RPMS/<span class="variable">$basearch</span></span><br><span class="line">enabled = 1</span><br><span class="line">gpgcheck = 1</span><br><span class="line">gpgkey = https://www.percona.com/downloads/RPM-GPG-KEY-percona</span><br><span class="line"></span><br><span class="line">[percona-release-noarch]</span><br><span class="line">name = Percona-Release YUM repository - noarch</span><br><span class="line">baseurl = http://repo.percona.com/release/7Server/RPMS/noarch</span><br><span class="line">enabled = 1</span><br><span class="line">gpgcheck = 1</span><br><span class="line">gpgkey = https://www.percona.com/downloads/RPM-GPG-KEY-percona</span><br><span class="line"></span><br><span class="line">[percona-release-source]</span><br><span class="line">name = Percona-Release YUM repository - Source packages</span><br><span class="line">baseurl = http://repo.percona.com/release/7Server/SRPMS</span><br><span class="line">enabled = 0</span><br><span class="line">gpgcheck = 1</span><br><span class="line">gpgkey = https://www.percona.com/downloads/RPM-GPG-KEY-percona</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<pre><code>3） 配置 epel 源
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	cat &gt; /etc/yum.repos.d/epel.repo &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[epel]</span><br><span class="line">name=Extra Packages <span class="keyword">for</span> Enterprise Linux 7 - <span class="variable">$basearch</span></span><br><span class="line">baseurl=http://dl.fedoraproject.org/pub/epel/7Server/x86_64/</span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-7Server</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<pre><code>4）配置 centos base 源
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	cat &gt; /etc/yum.repos.d/base.repo &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[base]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Base</span><br><span class="line">baseurl=http://olcentchan.chinacloudapp.cn/centos/<span class="variable">$releasever</span>/os/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line"><span class="comment">#released updates</span></span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Updates</span><br><span class="line">baseurl=http://olcentchan.chinacloudapp.cn/centos/<span class="variable">$releasever</span>/updates/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line"><span class="comment">#additional packages that may be useful</span></span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Extras</span><br><span class="line">baseurl=http://olcentchan.chinacloudapp.cn/centos/<span class="variable">$releasever</span>/extras/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line"><span class="comment">#additional packages that extend functionality of existing packages</span></span><br><span class="line">[centosplus]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Plus</span><br><span class="line">baseurl=http://olcentchan.chinacloudapp.cn/centos/<span class="variable">$releasever</span>/centosplus/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line"><span class="comment">#contrib - packages by Centos Users</span></span><br><span class="line">[contrib]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Contrib</span><br><span class="line">baseurl=http://olcentchan.chinacloudapp.cn/centos/<span class="variable">$releasever</span>/contrib/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre><code>1) 安装 mariadb

    yum install -y MariaDB-server MariaDB-client galera rsync 

    因为从10.1开始galera默认依赖，并且包含在mariadb源中，因此安装server和client就可以了。
    rsync mariadb默认使用的集群同步工具，centos 7.3 默认已经安装。


2) 安装jemalloc, google 研发的高效内存管理模块，默认系统已安装

    yum install jemalloc jemalloc-devel


3）安装Percona XtraBackup

    mariadb默认使用rsync进行节点间数据同步.
    单rsync同步的时候会锁住节点，没有Percona提供的XtraBackup顺畅.
    因此这里使用推荐的XtraBackup，需要下载安装

    安装Percona XtraBackup 的yum安装源

    yum install -y http://www.percona.com/downloads/percona-release/redhat/0.1-4/percona-release-0.1-4.noarch.rpm

    或者手动配置yum源

    yum install percona-xtrabackup-24


    在yum中查找最新版本进行安装

    yum list | grep percona-xtrabackup

    yum install -y percona-xtrabackup-24


4）安装socat，否则xtrabackup备份同步方式在单节点故障后重启后在.err错误日志中会报类似以下错误

    WSREP_SST: [ERROR] socat not found in path: /usr/sbin:/sbin....

    yum install -y socat


5) 配置NTP（chrony）

    $ yum install chrony
    $ systemctl enable chronyd.service
    $ systemctl start chronyd.service
    $ systemctl status chronyd.service


6) 启动时，在run里自动创建mysql目录

    vi /usr/lib/systemd/system/mariadb.service
    [Service]
    ......

    #PermissionsStartOnly=true
    RuntimeDirectory=mysql
    RuntimeDirectoryMode=0755
    User=mysql
    Group=mysql

    ......
</code></pre><h2 id="修改root用户默认密码"><a href="#修改root用户默认密码" class="headerlink" title="修改root用户默认密码"></a>修改root用户默认密码</h2><pre><code>本文中选择IP为192.168.56.21的虚机作为演示节点进行配置，mariadb安装后默认服务是启动的

1) 修改root用户默认密码

    mysqladmin -u root password &quot;root的登录密码&quot;  

    或者

    mysql_secure_installation (这种方式初学者可能会选错，所以建议用前一种方式)

2) 本文使用sst_user用户作为集群的数据同步用户，授予所有权限

    进入mysql管理命令

    mysql -uroot -p

    MariaDB&gt; CREATE USER &apos;sst_user&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;sst_pass&apos;;
    MariaDB&gt; GRANT ALL PRIVILEGES ON *.* TO &apos;sst_user&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;sst_pass&apos;; 
    # (如果想让用户拥有授有权限，在语句最后加WITH GRANT OPTION)
    MariaDB&gt; FLUSH PRIVILEGES;
</code></pre><h2 id="关闭mysql服务，为后续配置做准备"><a href="#关闭mysql服务，为后续配置做准备" class="headerlink" title="关闭mysql服务，为后续配置做准备"></a>关闭mysql服务，为后续配置做准备</h2><pre><code>systemctl stop mariadb
</code></pre><h2 id="数据目录准备："><a href="#数据目录准备：" class="headerlink" title="数据目录准备："></a>数据目录准备：</h2><pre><code>1) 安装 semanage 管理工具

    yum -y install policycoreutils-python

2) 准备pid socket 目录，防止内存里

    mkdir /var/run/mysql
    chown -R mysql:mysql /var/run/mysql
    mkdir -p /data/{mysql,tmp/mysql,log/mysql}

3) 数据目录权限和selinux上下文

    chown -R mysql:mysql /data/mysql
    chmod -R 0755 /data/mysql
    semanage fcontext -a -t mysqld_db_t &quot;/data/mysql(/.*)?&quot;
    restorecon -RFv /data/mysql

4) 临时目录权限和selinux上下文

    chown -R mysql:mysql /data/tmp/mysql
    chmod -R 0755 /data/tmp/mysql
    semanage fcontext -a -t mysqld_db_t &quot;/data/tmp/mysql(/.*)?&quot;
    restorecon -RFv /data/tmp/mysql

5） 日志目录权限和selinux上下文

    chown -R mysql:mysql /data/log/mysql
    chmod -R 0755 /data/log/mysql
    semanage fcontext -a -t var_log_t &quot;/data/log/mysql(/.*)?&quot;
    restorecon -RFv /data/log/mysql

6) socket selinux设置

    semanage fcontext -a -t mysqld_var_run_t &quot;${DB_datadir}/{mysql.sock，mysql.pid}&quot;    
    restorecon -RFv ${DB_datadir}/{mysql.sock，mysql.pid}

7) 设置 端口 selinux 

    semanage port -a -t mysqld_port_t -p tcp 3306
</code></pre><h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><pre><code>配置文件路径：

    /etc/my.cnf.d/server.cnf 


mariadb的配置文件很多，安装之后有

    /etc/my.cnf
    /etc/my.cnf.d/mysql-clients.cnf
    /etc/my.cnf.d/server.cnf


    其中/etc/my.cnf文件中包含了后两者

    /etc/my.cnf.d/mysql-client.cnf中存放客户端连接时的配置信息，

    例如[client]和[mysql]，/etc/my.cnf.d/server.cnf中存放服务器的配置信息

    可以将所有信息添加到server.cnf，也可以分为client和server配置文件


查找配置文件所在位置以及配置信息的命令,按空格键下翻

    mysqld –help –verbose | more
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    vi /etc/my.cnf.d/server.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment">### 客户端连接配置 #####################################</span></span><br><span class="line">[client]</span><br><span class="line">port                    = 3306</span><br><span class="line">socket                  = /var/run/mysql/mysql.sock   <span class="comment"># 设置客户端连接socket文件路径，如果mariadb采用socket连接，且更改了默认socket路径配置，客户端就必须设置</span></span><br><span class="line">default-character-set   = utf8                        <span class="comment"># 设置客户端连接默认连接字符类型</span></span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">### 默认或基本配置 #####################################</span></span><br><span class="line"><span class="built_in">bind</span>-address    = 0.0.0.0</span><br><span class="line">port            = 3306</span><br><span class="line">socket          = /run/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">basedir         = /usr                                  <span class="comment"># mysqld二进制文件存放的目录，或者说mysql安装目录</span></span><br><span class="line">datadir         = /data/mysql                           <span class="comment"># 数据库文件存放目录</span></span><br><span class="line">tmpdir          = /data/tmp/mysql</span><br><span class="line">pid_file        = /run/mysql/mysql.pid              <span class="comment"># 存放数据库进程ID文件</span></span><br><span class="line">log_error       = /data/<span class="built_in">log</span>/mysql/mariadb.error.log     <span class="comment"># 错误日志文件</span></span><br><span class="line"><span class="comment">#log_output     = FILE                              # 参数log_output指定了慢查询输出的格式，默认为FILE，你可以将它设为TABLE，然后就可以查询mysql架构下的slow_log表了  </span></span><br><span class="line"><span class="comment">#log-warnings   = 1                                 # 将警告信息也记入到日志中 </span></span><br><span class="line"></span><br><span class="line">sync_binlog             = 0                         <span class="comment"># 默认为0 ,就是由文件系统自己控制它的缓存的刷新，系统crash会丢失很多没刷新的事务日志；sync_binlog=n，当每进行n次事务提交之后，MySQL将进行一次fsync之类的磁盘同步指令来将binlog_cache中的数据刷入磁盘。。此值可以设为100.</span></span><br><span class="line">open_files_limit        = 65535                     <span class="comment"># 该参数用于控制MySQL实例能够同时打开使用的文件句柄数目。</span></span><br><span class="line">max_connections         = 4096                      <span class="comment"># 最大连接数</span></span><br><span class="line">back_log                = 500                       <span class="comment">#接受队列，对于没建立tcp连接的请求队列放入缓存中，队列大小为back_log，受限制与OS参数</span></span><br><span class="line">max_connect_errors      = 10000                     <span class="comment"># 如果某个用户发起的连接error超过该数值，则该用户的下次连接将被阻塞，直到管理员执行flush hosts ; 命令；防止黑客   </span></span><br><span class="line">collation-server        = utf8_general_ci           <span class="comment"># 查询比较不区分大小写</span></span><br><span class="line">character-set-server    = utf8                      <span class="comment"># 数据库采用UTF8字符集</span></span><br><span class="line"><span class="comment">#default-time-zone       = system                    #服务器时区  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># skip options  </span></span><br><span class="line">skip-name-resolve               <span class="comment"># 取消域名解析，服务器连接等相关设置只能用IP不能用域名，这样加快访问速度  </span></span><br><span class="line">skip-symbolic-links             <span class="comment"># 不能使用连接文件  </span></span><br><span class="line">skip-external-locking           <span class="comment"># 不使用系统锁定，要使用myisamchk,必须关闭服务器  </span></span><br><span class="line"><span class="comment">#skip-slave-start               # 启动mysql时,不自动启动从复制  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">### innodb引擎配置 #####################################</span></span><br><span class="line"></span><br><span class="line">default-storage-engine          = innodb                        <span class="comment"># 数据库默认引擎采用innodb</span></span><br><span class="line">innodb_file_per_table           = 1                             <span class="comment"># 采用innodb引擎是，每表存放一个文件</span></span><br><span class="line">innodb_buffer_pool_size         = 1G</span><br><span class="line">innodb_open_files               = 6000                          <span class="comment"># innodb 打开文件的最大数量，受限于系统文件打开的数量</span></span><br><span class="line"></span><br><span class="line">innodb_data_home_dir            = /data/mysql                   <span class="comment"># innodb数据文件存放路径</span></span><br><span class="line">innodb_data_file_path           = ibdata1:100M:autoextend       <span class="comment"># 一般一个文件对一应一个磁盘</span></span><br><span class="line">innodb_log_group_home_dir       = /data/mysql                   <span class="comment"># innodb事物日志文件存放路径</span></span><br><span class="line">innodb_log_files_in_group       = 2                             <span class="comment"># 两组事物日志  </span></span><br><span class="line">innodb_log_file_size            = 128M                          <span class="comment"># innodb事物日志大小，越大，恢复时间越长。</span></span><br><span class="line">innodb_log_buffer_size          = 8M                            <span class="comment"># innodb事物日志缓存，此值默认8M，对系统提升不高</span></span><br><span class="line">innodb_flush_log_at_trx_commit  = 2                             <span class="comment"># 2 为1秒内刷新日志，适合于游戏之类的服务器；1 为每事务刷新一次，适合对数据要求极高的；0 适合数据不太重要，追求效率的</span></span><br><span class="line">innodb_lock_wait_timeout        = 50                            <span class="comment"># InnoDB事务在被回滚之前可以等待一个锁定的超时秒数。InnoDB在它自己的 锁定表中自动检测事务死锁并且回滚事务。InnoDB用LOCK TABLES语句注意到锁定设置。默认值是50秒</span></span><br><span class="line">innodb_autoinc_lock_mode        = 2                             <span class="comment"># 用于控制自增主键的锁机制，该参数可以设置的值为0/1/2。</span></span><br><span class="line"><span class="comment"># 建议将参数设置改为2，则表示所有情况插入都使用轻量级别的mutex锁(只针对row模式)，这样就可以避免auto_inc的死锁，同时在INSERT … SELECT 的场景下会提升很大的性能（注意该参数设置为2，binlog的格式需要设置为row）。</span></span><br><span class="line"><span class="comment"># 参数设置为1，表示InnoDB使用轻量级别的mutex锁来获取自增锁，替代最原始的表级锁，但是在load data（包括：INSERT … SELECT, REPLACE … SELECT）场景下会使用自增表锁，这样会则可能导致应用在并发导入数据出现死锁。</span></span><br><span class="line"></span><br><span class="line">innodb_flush_method             = O_DSYNC </span><br><span class="line">innodb_max_dirty_pages_pct      = 90                            <span class="comment"># innodb主线程刷新缓存池中的数据，使脏数据比例小于90%  </span></span><br><span class="line"><span class="comment">#innodb_doublewrite             = 1                             # 集群默认必须设置为1</span></span><br><span class="line"><span class="comment">#innodb_thread_concurrency       = 16</span></span><br><span class="line"><span class="comment">#innodb-read-io-threads=4</span></span><br><span class="line"><span class="comment">#innodb-write-io-threads=4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 数据二进制日志 #####################################</span></span><br><span class="line">binlog_format           = ROW                           <span class="comment"># 集群和主从复制需要设置</span></span><br><span class="line">expire_logs_days        = 10 </span><br><span class="line"><span class="comment">#binlog_cache_size       = 1M</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面只有主从设置时才需要</span></span><br><span class="line"><span class="comment">#server_id               = 10</span></span><br><span class="line"><span class="comment">#log-bin                 = mysql-bin                     #这些路径相对于datadir  </span></span><br><span class="line"><span class="comment">#log-bin-index           = mysql-bin.index</span></span><br><span class="line"><span class="comment">#relayrelay-log         = relay-log</span></span><br><span class="line"><span class="comment">#relayrelay_log_index   = relay-log.index</span></span><br><span class="line"><span class="comment">#expire_logs_days       = 10                            # 日志保存几天，超时自动删除</span></span><br><span class="line"><span class="comment">#binlog-do-db           = bitnami_magento               # 主从同步的库，一般设置在从服务，同步那个数据库</span></span><br><span class="line"><span class="comment">#binlog-do-db           = test_magento</span></span><br><span class="line"><span class="comment">#binlog_ignore_db       = mysql</span></span><br><span class="line"><span class="comment">#binlog_ignore_db       = performance_schema            # 不同步哪个数据库</span></span><br><span class="line"><span class="comment">#binlog_ignore_db       = information_schema</span></span><br><span class="line"><span class="comment">#log-slave-updates      = 1                            # A-B-C， 如果三级主从，B就需要开启，用于将从主读取的日志写入自己的log-bin中用于自己的从服务器同步</span></span><br><span class="line"><span class="comment">#slave-skip-errors      = 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 超时设置 #################################</span></span><br><span class="line"><span class="comment">#wait-timeout                = 28800     #等待关闭连接的时间  </span></span><br><span class="line"><span class="comment">#interactive-timeout         = 28800     #关闭连接之前，允许interactive_timeout（取代了wait_timeout）秒的不活动时间。客户端的会话wait_timeout变量被设为会话interactive_timeout变量的值。  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#connect-timeout             = 10        #连接超时之前的最大秒数,在Linux平台上，该超时也用作等待服务器首次回应的时间  </span></span><br><span class="line"><span class="comment">#slave-net-timeout           = 600       #从服务器也能够处理网络连接中断。但是，只有从服务器超过slave_net_timeout秒没有从主服务器收到数据才通知网络中断  </span></span><br><span class="line"><span class="comment">#net_read_timeout            = 30        #从服务器读取信息的超时  </span></span><br><span class="line"><span class="comment">#net_write_timeout           = 60        #从服务器写入信息的超时  </span></span><br><span class="line"><span class="comment">#net_retry_count             = 10        #如果某个通信端口的读操作中断了，在放弃前重试多次  </span></span><br><span class="line"><span class="comment">#net_buffer_length           = 16384     #包消息缓冲区初始化为net_buffer_length字节，但需要时可以增长到max_allowed_packet字节</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 缓存 #####################################</span></span><br><span class="line"><span class="comment">#tmp_table_size              = 512M      #临时表大小，如果超过该值，则结果放到磁盘中  </span></span><br><span class="line"><span class="comment">#max_heap_table_size         = 512M      #该变量设置MEMORY (HEAP)表可以增长到的最大空间大小,参数目的是防止建立超大的内存临时表</span></span><br><span class="line"></span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line"></span><br><span class="line">read_buffer_size = 2M</span><br><span class="line">sort_buffer_size = 2M</span><br><span class="line">join_buffer_size = 2M</span><br><span class="line">read_rnd_buffer_size = 4M</span><br><span class="line"></span><br><span class="line">table_cache                 = 512       <span class="comment"># 所有线程打开的表的数目。增大该值可以增加mysqld需要的文件描述符的数量  </span></span><br><span class="line">table_open_cache            = 256</span><br><span class="line"></span><br><span class="line">thread_stack                = 192K      <span class="comment"># 每个线程的堆栈大小  </span></span><br><span class="line">thread_cache_size           = 8         <span class="comment"># 线程缓存  </span></span><br><span class="line"><span class="comment">#thread_concurrency          = 8         # 同时运行的线程的数据 此处最好为CPU个数两倍。本机配置为CPU的个数  </span></span><br><span class="line"></span><br><span class="line">query_cache_size            =0</span><br><span class="line"><span class="comment">#query_cache_size            = 256M      #查询缓存大小  </span></span><br><span class="line">query_cache_limit           = 4M        <span class="comment">#不缓存查询大于该值的结果  </span></span><br><span class="line">query_cache_min_res_unit    = 2K        <span class="comment">#查询缓存分配的最小块大小  </span></span><br><span class="line"></span><br><span class="line">key_buffer_size = 256M</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 慢查询 #####################################</span></span><br><span class="line">slow_query_log              = 1 </span><br><span class="line">long-query-time             = 5          <span class="comment">#慢查询时间 超过1秒则为慢查询  </span></span><br><span class="line">slow_query_log_file         = /data/<span class="built_in">log</span>/mysql/slow.log  </span><br><span class="line"><span class="comment">#log-queries-not-using-indexes  </span></span><br><span class="line"><span class="comment">#log-slow-slave-statements </span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 集群配置 #####################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群相关配置，注意集群服务器必须设置default_storage_engine=InnoDB, binlog_format=ROW, innodb_autoinc_lock_mode=2</span></span><br><span class="line">[galera]</span><br><span class="line">wsrep_on                = ON                                        <span class="comment">#(决定是否启动节点间同步,该配置项从10.1.1版本增加的，必须配置ON选项。)</span></span><br><span class="line">wsrep_provider          = /usr/lib64/galera/libgalera_smm.so        <span class="comment">#(指定Galera的库,galera 的同步c++库位置)</span></span><br><span class="line">wsrep_provider_options  = <span class="string">"gcache.size=2G; gcache.page_size=1G"</span></span><br><span class="line">wsrep_cluster_name      = <span class="string">"db_cluster"</span>                              <span class="comment">#(整个集群的名称，所有节点一致,字符开头，可以包含数字和下划线)</span></span><br><span class="line"><span class="comment">#wsrep_cluster_address  = "gcomm://"                                # 当整个集群都停机后，第一台启动时设置为空，注意此机必须是最后一台关机的服务器</span></span><br><span class="line">wsrep_cluster_address   = <span class="string">"gcomm://10.100.120.4,10.100.120.5,10.100.120.6"</span> <span class="comment">#(集群中所有节点的地址列表，在Percona中第一个启动的节点必须是空值才能启动，MariaDB已无此限制)</span></span><br><span class="line">wsrep_node_name         = db01                                      <span class="comment">#(节点名称，其它两个节点需要修改)</span></span><br><span class="line">wsrep_node_address      = 10.100.120.4                              <span class="comment">#(节点地址，其它两个节点需要修改)</span></span><br><span class="line">wsrep_sst_method        = rsync</span><br><span class="line"><span class="comment">#wsrep_sst_method       = xtrabackup-v2                             #默认是rsync全量拷贝，但是需要在donor节点上执行全局读锁(flushtables with read lock)，建议采用xtrabackup热备份方式，只有在备份.frm表结构文件才会锁表</span></span><br><span class="line"><span class="comment"># SST authentication string. This will be used to send SST to joining nodes.</span></span><br><span class="line"><span class="comment">#wsrep_sst_auth         = sst_user:sst_pass                         #集群间的身份验证</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># enable "strictly synchronous" semantics for read operations</span></span><br><span class="line"><span class="comment"># deprecated</span></span><br><span class="line"><span class="comment">#wsrep_causal_reads=ON  #节点应用完事务才返回查询请求， 避免脏读</span></span><br><span class="line"><span class="comment">#--wsrep-sync-wait=0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 二进制日志的格式必须为ROW格式。</span></span><br><span class="line">binlog_format           = ROW</span><br><span class="line"><span class="comment">#指定默认存储引擎为innodb。集群只支持innodb和xtradb</span></span><br><span class="line">default_storage_engine  = InnoDB</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># How many threads will process writesets from other nodes</span></span><br><span class="line">wsrep_slave_threads=1               <span class="comment">#可以指定wsrep的线程数，提高复制效率。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># to enable debug level logging, set this to 1</span></span><br><span class="line">wsrep_debug=0</span><br><span class="line">wsrep_convert_LOCK_to_trx=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># how many times to retry deadlocked autocommits</span></span><br><span class="line">wsrep_retry_autocommit=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># replicate myisam</span></span><br><span class="line">wsrep_replicate_myisam=1</span><br><span class="line"><span class="comment"># retry autoinc insert, which failed for duplicate key error</span></span><br><span class="line">wsrep_drupal_282555_workaround=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate fake primary keys for non-PK tables (required for multi-master</span></span><br><span class="line"><span class="comment"># and parallel applying operation)</span></span><br><span class="line"><span class="comment">#为没有显式申明主键的表生成一个用于certificationtest的主键，默认为ON  </span></span><br><span class="line">wsrep_certify_nonPK=1               </span><br><span class="line"></span><br><span class="line"><span class="comment"># change auto_increment_increment and auto_increment_offset automatically</span></span><br><span class="line">wsrep_auto_increment_control=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Maximum number of rows in write set</span></span><br><span class="line">wsrep_max_ws_rows=131072</span><br><span class="line"></span><br><span class="line"><span class="comment"># Maximum size of write set</span></span><br><span class="line">wsrep_max_ws_size=1073741824</span><br><span class="line"></span><br><span class="line"><span class="comment"># Address for incoming client connections. Autodetect by default.</span></span><br><span class="line"><span class="comment">#wsrep_node_incoming_address=10.100.120.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Address on THIS node to receive SST at. DON'T SET IT TO DONOR ADDRESS!!!</span></span><br><span class="line"><span class="comment"># (SST method dependent. Defaults to the first IP of the first interface)</span></span><br><span class="line"><span class="comment">#wsrep_sst_receive_address=10.100.120.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 其它配置 #####################################</span></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="comment"># 使用jemalloc作为内存管理，需要安装jemalloc jemalloc-devel</span></span><br><span class="line">malloc-lib=/usr/lib64/libjemalloc.so</span><br><span class="line"></span><br><span class="line">basedir         = /usr                                  <span class="comment"># mysqld二进制文件存放的目录，或者说mysql安装目录</span></span><br><span class="line">datadir         = /data/mysql                           <span class="comment"># 数据库文件存放目录</span></span><br><span class="line">pid_file        = /var/run/mysql/mysql.pid              <span class="comment"># 存放数据库进程ID文件</span></span><br><span class="line">log_error       = /data/<span class="built_in">log</span>/mysql/mariadb.error.log     <span class="comment"># 错误日志文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br><span class="line">default-character-set = utf8</span><br><span class="line">socket          = /run/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">[myisamchk]</span><br><span class="line">key_buffer_size = 128M</span><br><span class="line">sort_buffer_size = 128M</span><br><span class="line">read_buffer = 2M</span><br><span class="line">write_buffer = 2M</span><br><span class="line"></span><br><span class="line">[mysqlhotcopy]</span><br><span class="line">interactive-timeout</span><br></pre></td></tr></table></figure>
<h2 id="启动初始化及注意事项"><a href="#启动初始化及注意事项" class="headerlink" title="启动初始化及注意事项"></a>启动初始化及注意事项</h2><pre><code>1) 在其它两个节点上复制配置文件，注意其中的wsrep_node_name和wsrep_node_address需要根据节点实际情况修改

2) 初始化所有节点的数据库

    mkdir /var/run/mysql
    chown -R mysql:mysql /var/run/mysql

    rm -rf /var/lib/mysql/*
    rm -rf /data/mysql/*
    mysql_install_db --basedir=/usr --datadir=/data/mysql --user=mysql

    测试结果，所有节点配置一样，如果第一个节点有数据，运行galera_new_cluster启动cluster，后面的加入的节点数据目录可以为空。

    临时关闭安全

    setenforce 0
    systemctl stop firewalld
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="comment"># 集群最简单配置，如果复杂配置启动不了，可以先用最简单配置，然后重做初始数据库</span></span><br><span class="line"></span><br><span class="line">	cat &gt; /etc/my.cnf.d/server.cnf &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[galera]</span><br><span class="line">wsrep_on=ON</span><br><span class="line">wsrep_provider=/usr/lib64/galera/libgalera_smm.so</span><br><span class="line">wsrep_cluster_address=<span class="string">"gcomm://10.100.120.4,10.100.120.5,10.100.120.6"</span></span><br><span class="line">wsrep_provider_options  = <span class="string">"gcache.size=2G; gcache.page_size=1G"</span></span><br><span class="line">wsrep_cluster_name=<span class="string">"db_cluster"</span></span><br><span class="line">wsrep_node_address=<span class="string">"10.100.120.5"</span></span><br><span class="line">wsrep_node_name=<span class="string">"db05"</span></span><br><span class="line">wsrep_sst_method=rsync</span><br><span class="line">wsrep_sst_auth=sst_user:sst_pass</span><br><span class="line"></span><br><span class="line">binlog_format=row</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line"><span class="built_in">bind</span>-address=0.0.0.0</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<pre><code>3) 使用专有命令启动第一个节点

    galera_new_cluster 

    该命令暗示现在没有已存在的集群，启动的这台服务器是这个集群中的第一个，会产生新的集群UUID.

    如果集群已经存在还使用该命令会导致启动的服务器和已存在的集群不在一个集群体系中，因为产生了不一样的集群UUID


3) 在保证第一个节点启动后逐个启动其它节点，不要并行启动，可能会出预料不到的问题，如果第一个节点没启动，其它节点无法正常启动。

    systemctl start mariadb

    # 查看集群大小
    mysql -u root -p -e &quot;SHOW STATUS LIKE &apos;wsrep_cluster_size&apos;&quot;

    mysql -uroot -p -e &quot;CREATE DATABASE IF NOT EXISTS tocloud DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;&quot;
    mysql -uroot -p -e &quot;GRANT ALL ON tocloud.* TO test@&apos;%&apos; IDENTIFIED BY &apos;test.9898&apos;;&quot;

    如果使用xtrabackup-v2作为同步组件，创建后续在集群同步中拥有同步权限的用户并赋予最基本权限

    mysql&gt; GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT ON *.* TO &apos;sst_user&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;sst_pass&apos;;
    mysql&gt; FLUSH PRIVILEGES;

    或者 

    mysql -uroot -p -e &quot;grant all privileges on *.* to &apos;sst_user&apos;@&apos;%&apos; identified by &apos;sst_pass&apos;;FLUSH PRIVILEGES;&quot;


4) 一定注意集群中最后关闭的服务器应该是下次启动的第一个服务器，因为集群判断这台服务器最后关闭所以具有最完整的数据，所以会设置在这台服务器之前关闭的服务器无法正常手动启动，如果强制启动需要手动将grastate.dat文件中的safe_to_boostrap设置为1后强行启动。

    重启集群需要修改，最后一个关闭的服务器配置文件下面这个参数为：
    wsrep_cluster_address=&quot;gcomm://“

    然后重启最后关闭的服务器，再重启其它服务器，最后改回第一台的配置重新启动

    最后用此命令查看配置id 集群id 及状态是否一致
    mysql -u root -p -e &quot;SHOW STATUS LIKE &apos;wsrep_cluster%&apos;&quot;


    Restarting the cluster

    If you shut down all nodes, you effectively terminated the cluster (not the data of course, but the running cluster), hence the right way is to start the all the nodes with gcomm://&lt;node1 address&gt;,&lt;node2 address&gt;,...?pc.wait_prim=no again. On one of the nodes set global wsrep_provider_options=&quot;pc.bootstrap=true&quot;;.

    Bootstrapping a new cluster:

    $ mysqld --wsrep-new-cluster

    Adding another node to a cluster:

    $ mysqld --wsrep_cluster_address=gcomm://192.168.0.1  # DNS names work as well


5) 初始化

    # mysql_secure_installation

    # 添加超级用户：
    grant all on *.* to suroot@&apos;127.0.0.1&apos; identified by &apos;lion.net&apos; with grant option;
    grant all on *.* to suroot@&apos;::1&apos; identified by &apos;lion.net&apos; with grant option;
    grant all on *.* to suroot@&apos;localhost&apos; identified by &apos;lion.net&apos; with grant option;

    # 删除空用户和默认用户：
    drop user root@&apos;127.0.0.1&apos;;
    drop user root@&apos;::1&apos;;
    drop user root@&apos;localhost&apos;;
    drop user &apos;root&apos;@&apos;test-db-vm01&apos;;

    drop user &apos;&apos;@&apos;test-db-vm01&apos;;
    drop user &apos;&apos;@localhost;

    # 删除测试数据库
    drop database test;
</code></pre><h2 id="MariaDB负载均衡"><a href="#MariaDB负载均衡" class="headerlink" title="MariaDB负载均衡"></a>MariaDB负载均衡</h2><pre><code>当MariaDB Galera Cluster集群搭建完成后，通过任意一个节点都可以连接进行数据操作。

当然我们可以借助于haproxy或lvs来实现MySQL数据库集群之间的负载均衡
</code></pre><h3 id="使用mysql-router代理"><a href="#使用mysql-router代理" class="headerlink" title="使用mysql-router代理"></a>使用mysql-router代理</h3><pre><code>最好在每个应用的的服务器上安装mysqlrouter

应用最好使用socket连接mysqlrouter
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="comment"># yum 安装命令</span></span><br><span class="line"></span><br><span class="line">        yum install mysqlrouter</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置 mysqlrouter yum 源</span></span><br><span class="line"></span><br><span class="line">        cat &gt; /etc/yum.repos.d/mysql.repo &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[mysql-connectors-community]</span><br><span class="line">name=MySQL Connectors Community</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-connectors-community/el/7/\<span class="variable">$basearch</span>/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.mysql.com/RPM-GPG-KEY-mysql</span><br><span class="line"></span><br><span class="line">[mysql-tools-community]</span><br><span class="line">name=MySQL Tools Community</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-tools-community/el/7/\<span class="variable">$basearch</span>/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.mysql.com/RPM-GPG-KEY-mysql</span><br><span class="line"></span><br><span class="line">[mysql57-community]</span><br><span class="line">name=MySQL 5.7 Community Server</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-5.7-community/el/7/\<span class="variable">$basearch</span>/</span><br><span class="line">enabled=0</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.mysql.com/RPM-GPG-KEY-mysql</span><br><span class="line"></span><br><span class="line">[mysql80-community]</span><br><span class="line">name=MySQL 8.0 Community Server</span><br><span class="line">baseurl=http://repo.mysql.com/yum/mysql-8.0-community/el/7/\<span class="variable">$basearch</span>/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.mysql.com/RPM-GPG-KEY-mysql</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="comment"># mysqlrouter 配置</span></span><br><span class="line">    </span><br><span class="line">    cat &gt; /etc/mysqlrouter/mysqlrouter.conf &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[DEFAULT]</span><br><span class="line">logging_folder = /var/<span class="built_in">log</span>/mysqlrouter/</span><br><span class="line">plugin_folder = /usr/lib64/mysqlrouter</span><br><span class="line">runtime_folder = /var/run/mysqlrouter</span><br><span class="line">config_folder = /etc/mysqlrouter</span><br><span class="line"></span><br><span class="line">[logger]</span><br><span class="line"><span class="comment">## INFO (default), DEBUG, WARNING, ERROR, and FATAL</span></span><br><span class="line">level = WARNING</span><br><span class="line"></span><br><span class="line">[keepalive]</span><br><span class="line">interval = 60</span><br><span class="line"></span><br><span class="line"><span class="comment">## 主数据库，用于写</span></span><br><span class="line">[routing:primary]</span><br><span class="line">bind_address = 0.0.0.0</span><br><span class="line">bind_port=7001</span><br><span class="line">socket = /run/mysqlrouter/mysqlrouter.sock</span><br><span class="line">destinations = 200.200.200.221:3306,200.200.200.222:3306,200.200.200.223:3306</span><br><span class="line"><span class="comment">## first-available适用于cluster写集群；next-available适用于主从互备，主挂了将永远移除，除非重启mysqlrouter；round-robin适用于只读模式</span></span><br><span class="line">routing_strategy = first-available</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接到 MySQL Router 的最大连接数, 类似 MySQL Server 中的 max_connections 选项, 有效的值为 1 ~ 65535;</span></span><br><span class="line">max_connections = 512</span><br><span class="line"><span class="comment">## 有效的值为 1 ~ 65535;</span></span><br><span class="line"><span class="comment"># 工具连接后端 MySQL Server 的超时时间,单位秒, 默认为 1s, 有效的值为 1 ~ 65535;</span></span><br><span class="line">connect_timeout = 1</span><br><span class="line"></span><br><span class="line"><span class="comment">## 从数据库，用于读</span></span><br><span class="line">[routing:secondary]</span><br><span class="line">bind_address = 0.0.0.0</span><br><span class="line">bind_port = 7002</span><br><span class="line">destinations = 200.200.200.221:3307,200.200.200.222:3307,200.200.200.223:3307</span><br><span class="line">routing_strategy = round-robin</span><br><span class="line"></span><br><span class="line"><span class="comment">## 1-4294967296</span></span><br><span class="line">max_connect_errors = 100</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2 and 31536000</span></span><br><span class="line">client_connect_timeout = 9</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># vi /usr/lib/systemd/system/mysqlrouter.service</span></span><br><span class="line"></span><br><span class="line">    [Unit]</span><br><span class="line">    Description=MySQL Router</span><br><span class="line">    After=syslog.target</span><br><span class="line">    After=network.target</span><br><span class="line"></span><br><span class="line">    [Service]</span><br><span class="line">    Type=simple</span><br><span class="line">    User=mysqlrouter</span><br><span class="line">    Group=mysqlrouter</span><br><span class="line"></span><br><span class="line">    PIDFile=/var/run/mysqlrouter/mysqlrouter.pid</span><br><span class="line"></span><br><span class="line">    ExecStart=/usr/bin/mysqlrouter -c /etc/mysqlrouter/mysqlrouter.conf</span><br><span class="line"></span><br><span class="line">    PrivateTmp=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    [Install]</span><br><span class="line">    WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h3 id="安装设置haproxy"><a href="#安装设置haproxy" class="headerlink" title="安装设置haproxy"></a>安装设置haproxy</h3><pre><code>1) 安装

    yum install -y haproxy


2) 设置日志，编辑rsyslog

    # 取消下面两项注释，并添加一行：

    vi /etc/rsyslog.conf

        # Provides UDP syslog reception
        $ModLoad imudp
        $UDPServerRun 514

    # 设置rsyslog系统日志配置

    echo &apos;local2.*           /var/log/haproxy.log&apos; &gt; /etc/rsyslog.d/haproxy.conf


3) 编辑配置文件

    cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bk
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">global</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2</span><br><span class="line"></span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    <span class="comment"># turn on stats unix socket</span></span><br><span class="line">    stats socket /var/lib/haproxy/stats mode 600 level admin</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode    tcp</span><br><span class="line">    <span class="built_in">log</span>     global</span><br><span class="line">    option  dontlognull</span><br><span class="line">    option  redispatch</span><br><span class="line">    retries                   3</span><br><span class="line">    timeout queue             45s</span><br><span class="line">    timeout connect           5s</span><br><span class="line">    timeout client            1m</span><br><span class="line">    timeout server            1m</span><br><span class="line">    timeout check             10s</span><br><span class="line">    maxconn                   1020</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># HAProxy statistics backend</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">listen haproxy-monitoring *:9000</span><br><span class="line">    mode    http</span><br><span class="line">    stats   <span class="built_in">enable</span></span><br><span class="line">    stats   show-legends</span><br><span class="line">    stats   refresh           5s</span><br><span class="line">    stats   uri               /stats</span><br><span class="line">    stats   realm             Haproxy\ Statistics</span><br><span class="line">    stats   auth              test_user:test_pass</span><br><span class="line">    stats   admin             <span class="keyword">if</span> TRUE</span><br><span class="line">    stats   hide-version</span><br><span class="line"></span><br><span class="line">frontend mariadb   <span class="comment"># change on 2nd HAProxy</span></span><br><span class="line">    <span class="built_in">bind</span>    *:3030</span><br><span class="line">    default_backend           mariadb_cluster</span><br><span class="line"></span><br><span class="line">backend mariadb_cluster</span><br><span class="line">    balance leastconn</span><br><span class="line">    <span class="comment">##default-server port 9200 inter 2s downinter 5s rise 3 fall 2 slowstart 60s maxconn 64 maxqueue 128 weight 100</span></span><br><span class="line">    server  nodeA             10.100.120.4:3306 maxconn 151 check port 3306 inter 3s fastinter 1s downinter 5s rise 3 fall 3</span><br><span class="line">    server  nodeB             10.100.120.5:3306 maxconn 151 check port 3306 inter 3s fastinter 1s downinter 5s rise 3 fall 3</span><br><span class="line">    server  nodeC             10.100.120.6:3306 maxconn 151 backup check port 3306 inter 3s fastinter 1s downinter 5s rise 3 fall 3</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<pre><code>4) 配置haproxy的防护墙

    firewall-cmd --permanent --add-port=9000/tcp
    firewall-cmd --permanent --add-port=3030/tcp

    firewall-cmd --reload


5) 客户端访问测试

    mysql -u root -p -h 192.168.210.252 -P 3030 -e &quot;select Host, User, Password from mysql.user&quot;
</code></pre><h2 id="错误排查"><a href="#错误排查" class="headerlink" title="错误排查"></a>错误排查</h2><pre><code>1）xtrabackup方式的备份同步在单节点故障后重启会查找配置文件中的这个文件夹，否则会报类似以下错误


    .err日志文件错误如下：

    rm: cannot remove ‘/var/lib/mysql//innobackup.prepare.log’: No such file or directory
    rm: cannot remove ‘/var/lib/mysql//innobackup.move.log’: No such file or directory
    WSREP_SST: [INFO] Moving the backup to /var/lib/mysql/ (20170725 11:10:34.925)
    WSREP_SST: [INFO] Evaluating innobackupex   –no-version-check   –move-back –force-non-empty-directories ${DATA} &amp;&gt;${DATA}/innobackup.move.log (20170725 11:10:34.928)
    WSREP_SST: [ERROR] Cleanup after exit with status:1 (20170725 11:10:34.937)
    2017-07-25 11:10:34 140292539795200 [ERROR] WSREP: Process completed with error: wsrep_sst_xtrabackup-v2 –role ‘joiner’ –address ‘192.168.56.12’ –datadir ‘/var/lib/mysql/’   –parent ‘3212’  ” : 1 (Operation not permitted)
    2017-07-25 11:10:34 140292539795200 [ERROR] WSREP: Failed to read uuid:seqno and wsrep_gtid_domain_id from joiner script.
    2017-07-25 11:10:34 140292899555456 [ERROR] WSREP: SST failed: 1 (Operation not permitted)
    2017-07-25 11:10:34 140292899555456 [ERROR] Aborting

    innobackup.move.log 日志文件错误如下：

    Error: datadir must be specified

2）脑裂问题：

    执行下面命令，通过这个命令来强制恢复出现脑裂的节点。

    set global wsrep_provider_options=&quot;pc.bootstrap=true&quot;;

3）避免脏读

    Galera Cluster不是真正意义上的全同步复制，存在延迟。

    wsrep_causal_reads=ON;

4） 启动不了mairadb

    setenforce 0

    mkdir /run/mysql
    chown mysql:mysql  /run/mysql

    systemctl restart mariadb
</code></pre><h2 id="检查集群是否构建成功"><a href="#检查集群是否构建成功" class="headerlink" title="检查集群是否构建成功"></a>检查集群是否构建成功</h2><pre><code># mysql -e &quot;show status like &apos;wsrep_%&apos;&quot;

    +------------------------------+----------------------------------------------------------+
    | Variable_name                | Value                                                    |
    +------------------------------+----------------------------------------------------------+
    | wsrep_apply_oooe             | 0.000000                                                 |
    | wsrep_apply_oool             | 0.000000                                                 |
    | wsrep_apply_window           | 0.000000                                                 |
    | wsrep_causal_reads           | 0                                                        |
    | wsrep_cert_deps_distance     | 0.000000                                                 |
    | wsrep_cert_index_size        | 0                                                        |
    | wsrep_cert_interval          | 0.000000                                                 |
    | wsrep_cluster_conf_id        | 5                                                        |
    | wsrep_cluster_size           | 3                                                        |
    | wsrep_cluster_state_uuid     | 963cd314-7072-11e6-ac31-16d397a77e7e                     |
    | wsrep_cluster_status         | Primary                                                  |
    | wsrep_commit_oooe            | 0.000000                                                 |
    | wsrep_commit_oool            | 0.000000                                                 |
    | wsrep_commit_window          | 0.000000                                                 |
    | wsrep_connected              | ON                                                       |
    | wsrep_flow_control_paused    | 0.000000                                                 |
    | wsrep_flow_control_paused_ns | 0                                                        |
    | wsrep_flow_control_recv      | 0                                                        |
    | wsrep_flow_control_sent      | 0                                                        |
    | wsrep_incoming_addresses     | 172.29.32.200:3306,172.29.32.201:3306,172.29.32.202:3306 |
    | wsrep_last_committed         | 0                                                        |
    | wsrep_local_bf_aborts        | 0                                                        |
    | wsrep_local_cached_downto    | 18446744073709551615                                     |
    | wsrep_local_cert_failures    | 0                                                        |
    | wsrep_local_commits          | 0                                                        |
    | wsrep_local_index            | 0                                                        |
    | wsrep_local_recv_queue       | 0                                                        |
    | wsrep_local_recv_queue_avg   | 0.083333                                                 |
    | wsrep_local_replays          | 0                                                        |
    | wsrep_local_send_queue       | 0                                                        |
    | wsrep_local_send_queue_avg   | 0.000000                                                 |
    | wsrep_local_state            | 4                                                        |
    | wsrep_local_state_comment    | Synced                                                   |
    | wsrep_local_state_uuid       | 963cd314-7072-11e6-ac31-16d397a77e7e                     |
    | wsrep_protocol_version       | 5                                                        |
    | wsrep_provider_name          | Galera                                                   |
    | wsrep_provider_vendor        | Codership Oy &lt;info@codership.com&gt;                        |
    | wsrep_provider_version       | 3.5(rXXXX)                                               |
    | wsrep_ready                  | ON                                                       |
    | wsrep_received               | 12                                                       |
    | wsrep_received_bytes         | 1360                                                     |
    | wsrep_repl_data_bytes        | 0                                                        |
    | wsrep_repl_keys              | 0                                                        |
    | wsrep_repl_keys_bytes        | 0                                                        |
    | wsrep_repl_other_bytes       | 0                                                        |
    | wsrep_replicated             | 0                                                        |
    | wsrep_replicated_bytes       | 0                                                        |
    | wsrep_thread_count           | 2                                                        |
    +------------------------------+----------------------------------------------------------+

具体参数含义解释:

    以下参数能对整个集群的做集群完整性检查、节点状态检查、复制健康状态检查、网络瓶颈检查、冲突或死锁检测等，具体参数如下：

    wsrep_cluster_state_uuid

    #此参数的值是集群的UUID，每个节点应该一致，可以由此看出节点是否还是集群的一员。

    wsrep_cluster_status

    #集群节点的状态， 正常应该返回primary，其他状态异常，说明出现”分区”或是”split-brain”状况。

    wsrep_cluster_conf_id

    #显示集群变更次数，所有节点应该一致， 反之说明有节点与集群断开了。

    wsrep_cluster_size

    #集群中节点的数量。

    wsrep_incoming_addresses

    #集群中成员的IP地址和端口。

    wsrep_connected

    #当前是否连接中，如果该值为Off，且wsrep_ready的值也为Off，则说明该节点没有连接到集群。

    wsrep_flow_control_paused

    #表示复制停止了多长时间，即表明集群因为Slave延迟而慢的程度，值为0~1，越靠近0越好。值为1表示复制完全停止，可优化wsrep_slave_threads的值来改善。

    wsrep_flow_control_sent

    wsrep_flow_control_sent

    #表示该节点已经停止复制了多少次。

    wsrep_last_committed

    #最新提交事物的记录。

    wsrep_local_commits

    #本地SQL提交记录。

    wsrep_local_cert_failures

    #本地事物提交失败记录。

    wsrep_local_bf_aborts

    #本地事物回滚的次数。

    wsrep_local_send_queue

    wsrep_local_recv_queue 

    #本地发送和接收的队列。

    wsrep_local_send_queue_avg

    wsrep_local_recv_queue_avg 

    #表示slave事务队列的平均长度，slave瓶颈的预兆。

    wsrep_local_state_comment

    #是否在同步中，如果wsrep_connected为On，但wsrep_ready为OFF，则可以从该项查看原因。

    wsrep_ready

    #插件是否应用中。

    wsrep_replicated

    #随着复制发出的次数。

    wsrep_replicated_bytes

    #随着复制发出的字节数。
</code></pre><h2 id="动态增加节点"><a href="#动态增加节点" class="headerlink" title="动态增加节点"></a>动态增加节点</h2><pre><code>关于动态增加节点，只需要在/etc/my.cnf.d/server.conf 修改 wsrep_cluster_address=”gcomm://192.168.1.200″ 地址为cluster其中一个节点即可，

然后通过service mysql start 启动服务，会自动增加到集群节点中

注意点:集群是乐观的并发控制，如果有两个事务同时向集群中不同的节点同一行写入并提交，失败的节点将中止,会造成死锁问题

通过设置单点写入多点读取的方式可以解决此问题。下面链接是其中一种解决方案

http://www.severalnines.com/blog/avoiding-deadlocks-galera-set-haproxy-single-node-writes-and-multi-node-reads

目前存在的一些问题可以参考 https://mariadb.com/kb/en/mariadb/documentation/replication-cluster-multi-master/galera/mariadb-galera-cluster-known-limitations/
</code></pre><h2 id="wsrep-provider-option"><a href="#wsrep-provider-option" class="headerlink" title="wsrep_provider_option"></a>wsrep_provider_option</h2><pre><code>https://severalnines.com/blog/understanding-gcache-galera

1） 查看:

    mysql&gt; SHOW VARIABLES LIKE &apos;wsrep_provider_options&apos;\G
    ...
    base_port=4567;gcache.mem_size = 0; gcache.name = /var/lib/mysql/galera.cache; gcache.size = 128M; gcache.page_size = 128M;
    ...

2) 相关设置

    gcache.name 可单独设置缓存文件到另外一个磁盘，提高IO并发

    gcache.size 此参数定义作为‘IST增量同步’的内容源的galera.cache文件的大小。此文件设置的大些以便节点重新加入集群式更有可能采用IST而非SST。(默认128M)

    base_port 同步的专用端口
</code></pre><h2 id="偏移量-auto-increment"><a href="#偏移量-auto-increment" class="headerlink" title="偏移量 auto_increment"></a>偏移量 auto_increment</h2><pre><code>当更多的 MariaDB 加入到集群之后，集群中的数据库会自动进行协调，并且自动定义偏移量， 这个比较人性化，自动化，如下描述

MariaDB [tocloud]&gt; show variables like &apos;auto_increment%&apos;; 
+--------------------------+-------+
| Variable_name            | Value |
+--------------------------+-------+
| auto_increment_increment | 3     |
| auto_increment_offset    | 2     |
+--------------------------+-------+
</code></pre><h2 id="配置haproxy"><a href="#配置haproxy" class="headerlink" title="配置haproxy"></a>配置haproxy</h2><pre><code>实现功能：

1）健康检查，down机的mysql自动从业务去除
2）负载均衡，配置专用的mysql读，写集群ip，程序通过该IP处理业务

下面haproxy配置使用自带的mysql检测功能，只能检测mysql是否存活。
如果要检测数据库一致性，需要配置xinetd服务写检测脚本通过option httpchk实现（略）

1）安装haproxy

wget http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.23.tar.gz
tar xvzfhaproxy-1.4.23.tar.gz
cd haproxy-1.4.23
make TARGET=generic
make install

2)添加mysql用户，在集群任何一台操作即可，会自动同步

添加权限，用于haproxy检测，不需要任何权限，haproxy只检测是否能正常连接关闭mysql

mysql -uroot -p
GRANT USAGE ON test.* to gaojinbo@’10.10.10.1′;

3)建立haproxy配置文件

vi /etc/haproxy.cfg

global
        maxconn 40000
        #debug
        daemon
        #quiet
        user haproxy
        group haproxy
        nbproc 1
        log 127.0.0.1 local3
        spread-checks 2
defaults
        timeout server  5m
        timeout connect 5m
        timeout client  5m
        timeout http-request 30s
        timeout queue   5m

frontend db_haproxy_status
        bind :80
        default_backend db_status

frontend db_write
        bind 10.10.10.21:3306
        default_backend cluster_db_write

frontend db_read
        bind 10.10.10.22:3306
        default_backend cluster_db_read

backend cluster_db_write
        mode    tcp
        option  tcpka
        balance roundrobin
        option  mysql-check user gaojinbo
        server  mdb1 10.10.10.11:3306 weight 1 check port 3306
        server  mdb2 10.10.10.12:3306 weight 1 check port 3306
        server  mdb3 10.10.10.13:3306 weight 1 check port 3306

backend cluster_db_read
        mode    tcp
        option  tcpka
        balance roundrobin
        option  mysql-check user gaojinbo
        server  mdb1 10.10.10.11:3306 weight 1 check port 3306
        server  mdb2 10.10.10.12:3306 weight 1 check port 3306
        server  mdb3 10.10.10.13:3306 weight 1 check port 3306

backend db_status
        mode http
        stats enable
    #stats scope
    #stats hide-version
        stats refresh 5s
        stats uri /status
        stats realm Haproxy statistics
        stats auth gaojinbo:gaojinbo.com

说明：

haproxy配置的5分钟超时，如果需要mysql长连接的话，修改超时设置即可

4)启动haproxy

haproxy -f /etc/haproxy.cfg
</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><pre><code>通过上面的一系列测试，最后总结一下：

1. 在生产环境下应该避免使用大事务，不建议在高并发写入场景下使用Galera Cluster架构，会导致集群限流，从而引起整个集群hang住，出现生产故障。针对这种情况可以考虑主从，实现读写分离等手段。

2. 对数据一致性要求较高，并且数据写入不频繁，数据库容量也不大（50GB左右），网络状况良好的情况下，可以考虑使用Galera方案

3. MyISAM存储的表，Galera不支持同步。它仅支持XtraDB/ InnoDB存储引擎（虽然有对MyISAM实验支持，具体看wsrep_replicate_myisam系统变量）。
</code></pre><h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><pre><code>https://my.oschina.net/ioooi/blog/1476604

http://blog.csdn.net/jiangshouzhuang/article/details/62468778

http://www.cnblogs.com/sweetchildomine/p/7884960.html
</code></pre>
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mariadb/" rel="tag"><i class="fa fa-tag"></i> mariadb</a>
          
            <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/mongdb/mongoDB常用命令/" rel="next" title="mongoDB常用命令">
                <i class="fa fa-chevron-left"></i> mongoDB常用命令
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/hexo/install hexo on centos 7/" rel="prev" title="install hexo on centos 7">
                install hexo on centos 7 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">dolphin</p>
              <p class="site-description motion-element" itemprop="description">现实是强者理想的实现</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">61</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">46</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境"><span class="nav-number">1.</span> <span class="nav-text">环境:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安全设置"><span class="nav-number">2.</span> <span class="nav-text">安全设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-yum源"><span class="nav-number">3.</span> <span class="nav-text">配置 yum源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">4.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改root用户默认密码"><span class="nav-number">5.</span> <span class="nav-text">修改root用户默认密码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭mysql服务，为后续配置做准备"><span class="nav-number">6.</span> <span class="nav-text">关闭mysql服务，为后续配置做准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据目录准备："><span class="nav-number">7.</span> <span class="nav-text">数据目录准备：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改配置文件"><span class="nav-number">8.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动初始化及注意事项"><span class="nav-number">9.</span> <span class="nav-text">启动初始化及注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MariaDB负载均衡"><span class="nav-number">10.</span> <span class="nav-text">MariaDB负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用mysql-router代理"><span class="nav-number">10.1.</span> <span class="nav-text">使用mysql-router代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装设置haproxy"><span class="nav-number">10.2.</span> <span class="nav-text">安装设置haproxy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#错误排查"><span class="nav-number">11.</span> <span class="nav-text">错误排查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查集群是否构建成功"><span class="nav-number">12.</span> <span class="nav-text">检查集群是否构建成功</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态增加节点"><span class="nav-number">13.</span> <span class="nav-text">动态增加节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#wsrep-provider-option"><span class="nav-number">14.</span> <span class="nav-text">wsrep_provider_option</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#偏移量-auto-increment"><span class="nav-number">15.</span> <span class="nav-text">偏移量 auto_increment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置haproxy"><span class="nav-number">16.</span> <span class="nav-text">配置haproxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">17.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考："><span class="nav-number">18.</span> <span class="nav-text">参考：</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dolphin</span>

  

  
</div>











        








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>

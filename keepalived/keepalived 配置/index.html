<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="yum 安装yum install keepalived -y yum install tcpdump psmisc 编译安装cd /opt yum -y install gcc libnfnetlink-devel libnl3-devel openssl openssl-devel net-snmp-devel wget wget http://www.keepalived.org/softw">
<meta name="keywords" content="keepalived">
<meta property="og:type" content="article">
<meta property="og:title" content="keepalived 配置">
<meta property="og:url" content="http://dolphincn.github.io/keepalived/keepalived 配置/index.html">
<meta property="og:site_name" content="克隆人战争">
<meta property="og:description" content="yum 安装yum install keepalived -y yum install tcpdump psmisc 编译安装cd /opt yum -y install gcc libnfnetlink-devel libnl3-devel openssl openssl-devel net-snmp-devel wget wget http://www.keepalived.org/softw">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-07-23T02:00:02.395Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="keepalived 配置">
<meta name="twitter:description" content="yum 安装yum install keepalived -y yum install tcpdump psmisc 编译安装cd /opt yum -y install gcc libnfnetlink-devel libnl3-devel openssl openssl-devel net-snmp-devel wget wget http://www.keepalived.org/softw">






  <link rel="canonical" href="http://dolphincn.github.io/keepalived/keepalived 配置/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>keepalived 配置 | 克隆人战争</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">克隆人战争</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">为了生存, 为了私利,<br/>争斗才是人类历史的主旋律！</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dolphincn.github.io/keepalived/keepalived 配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dolphin">
      <meta itemprop="description" content="现实是强者理想的实现">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="克隆人战争">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">keepalived 配置
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-09 00:00:00" itemprop="dateCreated datePublished" datetime="2018-07-09T00:00:00+08:00">2018-07-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-23 10:00:02" itemprop="dateModified" datetime="2018-07-23T10:00:02+08:00">2018-07-23</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/keepalived/" itemprop="url" rel="index"><span itemprop="name">keepalived</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="yum-安装"><a href="#yum-安装" class="headerlink" title="yum 安装"></a>yum 安装</h2><pre><code>yum install keepalived -y
yum install tcpdump psmisc
</code></pre><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><pre><code>cd /opt
yum -y install gcc libnfnetlink-devel libnl3-devel openssl openssl-devel net-snmp-devel wget
wget http://www.keepalived.org/software/keepalived-2.0.5.tar.gz
tar xvf keepalived-2.0.5.tar.gz
cd keepalived-2.0.5
./configure --prefix=/usr/local/keepalived
make
make install
</code></pre><h2 id="开启接口共享IP功能和内核转发功能"><a href="#开启接口共享IP功能和内核转发功能" class="headerlink" title="开启接口共享IP功能和内核转发功能"></a>开启接口共享IP功能和内核转发功能</h2><pre><code>## 修改内核参数： /etc/sysctl.conf
net.ipv4.ip_nonlocal_bind = 1
net.ipv4.ip_forward = 1

## 允许程序绑定到不属于本地网卡的地址上
echo &apos;net.ipv4.ip_nonlocal_bind = 1&apos; &gt;&gt; /etc/sysctl.conf
echo &apos;net.ipv4.ip_forward = 1&apos; &gt;&gt; /etc/sysctl.conf
</code></pre><h2 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h2><pre><code>## 如果防火墙屏蔽了keepalived间的通讯，可能导致两台master

## keepalived 默认需要使用D类多播地址224.0.0.18 进行心跳通信
## keepalived 使用vrp协议进行通信（协议号码为112）
## VRRP协议既不属于TCP也不属于UDP，在协议类型选项需要选“All traffice”的选项来防止由于防火墙原因造成通信问题。
## 使用单播避免部分网络不允许组播，但vrrp_strict禁用单播，所有不能设置此项

## firewall 配置方法

firewall-cmd --permanent --new-service=vrrp
firewall-cmd --permanent --service=vrrp --set-description=&quot;Virtual Router Redundancy Protocol&quot;
firewall-cmd --permanent --service=vrrp --set-short=vrrp
firewall-cmd --permanent --service=vrrp --add-protocol=vrrp
firewall-cmd --permanent --service=vrrp --set-destination=ipv4:224.0.0.18
firewall-cmd --add-service=vrrp --permanent --zone=internal
firewall-cmd --reload


## 或者 oracle 介绍的方式,此方式重启失效

echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf
sysctl -p
firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface &quot;your interface&quot; --destination 224.0.0.18 --protocol vrrp -j ACCEPT
firewall-cmd --direct --permanent --add-rule ipv4 filter OUTPUT 0 --out-interface &quot;your interface&quot; --destination 224.0.0.18 --protocol vrrp -j ACCEPT
firewall-cmd --reload


## 修改配置文件方式
vi /etc/firewalld/direct.xml

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;direct&gt;
&lt;rule priority=&quot;0&quot; table=&quot;filter&quot; ipv=&quot;ipv4&quot; chain=&quot;OUTPUT&quot;&gt;&apos; --out-interface&apos; [ens33] --destination 224.0.0.18 --protocol vrrp -j ACCEPT&lt;/rule&gt;
&lt;rule priority=&quot;1&quot; table=&quot;filter&quot; ipv=&quot;ipv4&quot; chain=&quot;IN_public_allow&quot;&gt;-d 224.0.0.18 -j ACCEPT&lt;/rule&gt;
&lt;/direct&gt;


## 或者

firewall-cmd --zone=public --add-rich-rule=&apos;rule family=&quot;ipv4&quot; destination address=&quot;224.0.0.18&quot; protocol value=&quot;vrrp&quot; accept&apos; --permanent
Firewall-cmd --reload


## iptables 配置方法
iptables -A INPUT -d 224.0.0.18 -j ACCEPT

## keepalvied 使用 112 端口通信，加上防火墙规则
iptables -A INPUT -i ens37 -p 112 -j ACCEPT


# /sbin/iptables -I INPUT -i ens37 -d 224.0.0.0/8 -j ACCEPT
# /sbin/iptables -A INPUT -p 112 -i ens37 -j ACCEPT
# /sbin/iptables -A OUTPUT -p 112 -o ens37 -j ACCEPT
# /sbin/service iptables save
</code></pre><h2 id="Haproxy-结合使用问题"><a href="#Haproxy-结合使用问题" class="headerlink" title="Haproxy 结合使用问题"></a>Haproxy 结合使用问题</h2><pre><code>haproxy 监听绑定IP最好用，如*:80 或 0.0.0.0:80，否则无法在绑定vip:80 建立监听。
如果直接绑定vip:80，如果不是master，haproxy启动前机器是backup没有获得vip，那haproxy可能启动不了。

如果不是master，Haproxy 绑定vip:80，又能启动，解决办法就是：
允许程序绑定到不属于本地网卡的地址上
echo &apos;net.ipv4.ip_nonlocal_bind = 1&apos; &gt;&gt; /etc/sysctl.conf

haproxy代理服务器同时也要打开内核的转发功能。

## 检查广播问题，vrrp广播不通会导致脑裂

tcpdump -vvv -n -i ens37 host 224.0.0.18
</code></pre><h2 id="日志设置"><a href="#日志设置" class="headerlink" title="日志设置"></a>日志设置</h2><pre><code>## 修改 /etc/sysconfig/keepalived
## 把KEEPALIVED_OPTIONS=&quot;-D&quot; 修改为KEEPALIVED_OPTIONS=&quot;-D -d -S 0&quot;
# --vrrp               -P    Only run with VRRP subsystem.
# --check              -C    Only run with Health-checker subsystem.
# --dont-release-vrrp  -V    Dont remove VRRP VIPs &amp; VROUTEs on daemon stop.
# --dont-release-ipvs  -I    Dont remove IPVS topology on daemon stop.
# --dump-conf          -d    Dump the configuration data.
# --log-detail         -D    Detailed log messages.
# --log-facility       -S    0-7 Set local syslog facility (default=LOG_DAEMON)
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &gt; /etc/sysconfig/keepalived</span><br><span class="line">KEEPALIVED_OPTIONS=<span class="string">"-D -d -S 3"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">"s/#\$ModLoad imudp/\$ModLoad imudp/g"</span> /etc/rsyslog.conf</span><br><span class="line">sed -i <span class="string">"s/#\$UDPServerRun 514/\$UDPServerRun 514/g"</span> /etc/rsyslog.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">## #文件最末尾的"&amp;~"，如果没有此配置，日志除写入指定文件外，会同步写入messages文件；</span></span><br><span class="line">cat &gt; /etc/rsyslog.d/keepalived.conf &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">local3.*    /var/<span class="built_in">log</span>/keepalived.log</span><br><span class="line">&amp;~</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart rsyslog.service</span><br></pre></td></tr></table></figure>
<h2 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h2><pre><code>global_defs {                               ## 全局配置
    notification_email {                    ## 定义报警邮件地址
        tom@service.com
        IT@service.com
    }

    notification_email_from IT@service.com  ## 定义发送邮件的地址
    smtp_server 127.0.0.1                                  ## 邮箱服务器 
    smtp_connect_timeout 30                                ## 定义超时时间
    router_id haproxy01                                    ## 运行Keepalived服务器的一个标识，是发邮件时显示在邮件主题中的信息。

    vrrp_garp_master_refresh 60                            ## secs, default 0 (no refreshing)
    vrrp_garp_master_delay 5                               ## seconds, default 5, 0 for no second set

    #vrrp_iptables                                          ##禁止keepalived启动生成默认的iptables规则
    #vrrp_mcast_group4 224.17.17.17                         ##定义主备节点通过组播地址进行通告状态
}  
</code></pre><h2 id="监控检查"><a href="#监控检查" class="headerlink" title="监控检查"></a>监控检查</h2><pre><code>## 多个检查脚本，每个脚本权重都会添加，最终优先级=初始优先级+脚本1的权重+脚本2的权重+...

vrrp_script chk_haproxy {            ## 检测该服务器上haproxy服务的健康状态的
    script &quot;/bin/killall -0 haproxy &amp;&amp; exit 0 || exit 1&quot;
    #script &quot;/etc/keepalived/chk_haproxy.sh&quot;
    interval 2                       ## 每2秒检测一次
    weight 20                        ## 默认是2. 当脚本执行码为0，权重大于0时，vrrp实例优先级增加；当脚本执行码为非0，权重小于0时，vrrp实例优先级减小，其他情况优先级不变。
    fall 2                           ## 检测两次都失败才失败
    rise 1                           ## 检测一次成功就成功
}


## 检测端口是否开启可以用，如：script &quot;&lt;/dev/tcp/127.0.0.1/6379&quot;
</code></pre><figure class="highlight bash"><figcaption><span>## 判断非僵尸进程bash 语句, haproxy 采用master-worker模式，所以进程数要大于1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &gt; /etc/keepalived/chk_haproxy.sh &lt;&lt; EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">[[ \$(ps -C <span class="string">'haproxy'</span> -o <span class="built_in">stat</span>,cmd | grep -ve <span class="string">'^[Zz]'</span> | grep -iv <span class="string">'grep'</span> | wc -l) -ge 2 ]] &amp;&amp; <span class="built_in">exit</span> 0 || <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod u+x /etc/keepalived/chk_haproxy.sh</span><br></pre></td></tr></table></figure>
<h2 id="维护检查"><a href="#维护检查" class="headerlink" title="维护检查"></a>维护检查</h2><pre><code>vrrp_script chk_mantaince_down {
    script &quot;/etc/keepalived/chk_down.sh&quot;
    interval 2                       ## 每2秒检测一次
    weight  20                       ## 默认是2. 当脚本执行码为0，权重大于0时，vrrp实例优先级增加；当脚本执行码为非0，权重小于0时，vrrp实例优先级减小，其他情况优先级不变。
    fall 2                           ## 检测两次都失败才失败
    rise 1                           ## 检测一次成功就成功
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/chk_down.sh &lt;&lt; EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">[[ -f /etc/keepalived/down ]] &amp;&amp; exit 1 || exit 0</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod u+x /etc/keepalived/chk_down.sh</span><br></pre></td></tr></table></figure>
<h2 id="同步组"><a href="#同步组" class="headerlink" title="同步组"></a>同步组</h2><pre><code>vrrp_sync_group G1 {
    group {
        VI_1
        VI_2
        VI_5
    }
    notify_backup &quot;/usr/local/bin/vrrp.back arg1 arg2&quot;
    notify_master &quot;/usr/local/bin/vrrp.mast arg1 arg2&quot;
    notify_fault &quot;/usr/local/bin/vrrp.fault arg1 arg2&quot;
}
</code></pre><h2 id="虚拟ip配置-vrrp"><a href="#虚拟ip配置-vrrp" class="headerlink" title="虚拟ip配置 vrrp"></a>虚拟ip配置 vrrp</h2><pre><code>## 在主备节点设置优先级的时候，要确保当MASTER节点降级后的优先级要比BACKUP的优先级低，否则，VIP是无法进行漂移的。

## 主备不同之处
    1，router_id        不能一致
    2，state            MASTER/BACKUP
    3, priority         权重不能一致
    4, interface ens33  网络接口注意和本机对应


vrrp_instance VI_1 {                ## 定义实例，用来定义对外提供服务的VIP区域及其相关属性。
    state BACKUP                    ## 状态参数 MASTER|BACKUP
    interface ens33                 ## 绑定VIP的网卡
    virtual_router_id 50            ## 取值在0-255之间，用来区分多个instance的VRRP组播。主备此值要相同，同一个集群id一致，不同集群必须不一样。
    priority 100                    ## 节点优先级，值范围0～254，MASTER要比BACKUP高。抢占模式中，优先级高就切换为master。
    advert_int 1                    ## 组播信息发送时间间隔，两个节点必须设置一样，默认为1秒
    #garp_master_delay 10            ## 当切为主状态后多久更新ARP缓存，默认5秒。通知设备它现在控制新MAC地址的那些IP，覆盖他们的ARP缓存。
    #garp_master_refresh 60          ## 单位秒，默认0，不再发送ARP。表示master每隔多久发送一次arp更新。
    nopreempt                       ## 默认是抢占模式，要是用非抢占式的，master主机加上nopreempt，同时主备机器的state状态都必须是BACKUP。经测试使用此参数会导致主备不会自动切换，必须关闭keepalive才行。
    smtp_alert                      ## 状态转换时，利用global里的邮件配置，发送邮件通知

    authentication {                ## 认证
        auth_type PASS              ## 认证方式
        auth_pass 1111              ## 密码
    }
    virtual_ipaddress {             ## VIP会绑定在物理网卡，所以不需要新建一个网卡。
        ## &lt;IPADDR&gt;/&lt;MASK&gt; brd &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPE&gt; label &lt;LABEL&gt;
        200.200.200.240/24 dev ens33    ## 设备之间使用的虚拟ip地址
        #192.168.200.17/24 dev ens33 label ens33:3
    }

    ## mcast_src_ip &lt;IPADDR&gt;        ## 指定多播源ip地址，用于多播

    ## 配置单播
    unicast_src_ip 200.200.200.212  ## 指定单播源ip地址，本机IP
    unicast_peer {
        200.200.200.213             ## 对端IP地址,必须是绑定vip网卡上的ip，通过单播发送vrrp信息给对端
    }

    track_interface {               ## 监控以下网卡，如果任何一个不通就会切换到FALT状态。
        ens33
    }

    track_script {
        chk_haproxy
        chk_mantaince_down
    }

    #notify_master /home/keepshell/notify_master.sh     ## 作用：当成为MASTER时，以指定的用户和组执行脚本。
    #notify_backup /home/keepshell/notify_backup.sh     ## 作用：当成为BACKUP时，以指定的用户和组执行脚本。
    #notify_fault  /home/keepshell/notify_fault.sh      ## 作用：当该同步组Fault时，以指定的用户和组执行脚本。
    #notify        /home/keepshell/notify_stop.sh       ## 作用：在任何状态都会以指定的用户和组执行脚本。最后执行。

}
</code></pre><h2 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h2><h3 id="全局定义模块"><a href="#全局定义模块" class="headerlink" title="全局定义模块"></a>全局定义模块</h3><pre><code>! Configuration File for keepalived

global_defs {
notification_email {
    acassen@firewall.loc
    failover@firewall.loc
    sysadmin@firewall.loc #邮件报警
}
notification_email_from Alexandre.Cassen@firewall.loc 指定发件人
smtp_server 192.168.200.1  #指定smtp服务器地址
smtp_connect_timeout 30    指定smtp连接超时时间
router_id LVS_DEVEL  #负载均衡标识，在局域网内应该是唯一的。
vrrp_skip_check_adv_addr
vrrp_strict
vrrp_garp_interval 0
vrrp_gna_interval 0
}

说明：
notification_email：指定当keepalived出现问题时，发送邮件给哪些用户。
notification_emai_from：发送邮件时，邮件的来源地址。
smtp_server &lt;DOMAIN|IP&gt; [&lt;PORT&gt;]：smtp服务器的地址或域名。默认端口为25.如：smtp_server smtp.felix.com 25
smtp_helo_name &lt;HOST_NAME&gt;：指定在HELO消息中所使用的名称。默认为本地主机名。
smtp_connect_timeout：指定smtp服务器连接的超时时间。单位是秒。

router_id：指定标识该机器的route_id. 如：route_id LVS_01
vrrp_mcast_group4 224.0.0.18：指定发送VRRP组播消息使用的IPV4组播地址。默认是224.0.0.18
vrrp_mcast_group6 ff02::12 指定发送VRRP组播消息所使用的IPV6组播地址。默认是ff02::12
default_interface eth0：设置静态地址默认绑定的端口。默认是eth0。
lvs_sync_daemon &lt;INTERFACE&gt; &lt;VRRP_INSTANCE&gt; [id &lt;SYNC_ID&gt;] [maxlen &lt;LEN&gt;] [port &lt;PORT&gt;] [ttl &lt;TTL&gt;] [group &lt;IP ADDR&gt;]
    设置LVS同步服务的相关内容。可以同步LVS的状态信息。
    INTERFACE：指定同步服务绑定的接口。
    VRRP_INSTANCE：指定同步服务绑定的VRRP实例。
    id &lt;SYNC_ID&gt;：指定同步服务所使用的SYNCID，只有相同的SYNCID才会同步。范围是0-255.
    maxlen：指定数据包的最大长度。范围是1-65507
    port：指定同步所使用的UDP端口。
    group：指定组播IP地址。

lvs_flush：                     在keepalived启动时，刷新所有已经存在的LVS配置。
vrrp_garp_master_delay 10：     当转换为MASTER状态时，延迟多少秒发送第二组的免费ARP。默认为5s，0表示不发送第二组免的免费ARP。
vrrp_garp_master_repeat 1：     当转换为MASTER状态时，在一组中一次发送的免费ARP数量。默认是5.
vrrp_garp_lower_prio_delay 10： 当MASTER收到更低优先级的通告时，延迟多少秒发送第二组的免费ARP。
vrrp_garp_lower_prio_repeat 1： 当MASTER收到更低优先级的通告时，在一组中一次发送的免费ARP数量。
vrrp_garp_master_refresh 60：   当keepalived成为MASTER以后，刷新免费ARP的最小时间间隔(会再次发送免费ARP)。默认是0，表示不会刷新。
vrrp_garp_master_refresh_repeat 2： 当keepalived成为MASTER以后，每次刷新会发送多少个免费ARP。默认是1.
vrrp_garp_interval 0.001：          在一个接口发送的两个免费ARP之间的延迟。可以精确到毫秒级。默认是0.
vrrp_lower_prio_no_advert true|false：默认是false。如果收到低优先级的通告，不发送任何通告。
vrrp_version 2|3：                  设置默认的VRRP版本。默认是2.
vrrp_check_unicast_src：            在单播模式中，开启对VRRP数据包的源地址做检查，源地址必须是单播邻居之一。
vrrp_skip_check_adv_addr：          默认是不跳过检查。检查收到的VRRP通告中的所有地址可能会比较耗时，设置此命令的意思是，如果通告与接收的上一个通告来自相同的master路由器，则不执行检查(跳过检查)。
vrrp_strict：                       严格遵守VRRP协议。      下列情况将会阻止启动Keepalived：1. 没有VIP地址。2. 单播邻居。3. 在VRRP版本2中有IPv6地址。

vrrp_iptables：                     不添加任何iptables规则。默认是添加iptables规则的。

如果vrrp进程或check进程超时，可以用下面的4个选项。可以使处于BACKUP状态的VRRP实例变成MASTER状态，即使MASTER实例依然在运行。因为MASTER或BACKUP系统比较慢，不能及时处理VRRP数据包。
vrrp_priority &lt;-20 -- 19&gt;：         设置VRRP进程的优先级。
checker_priority &lt;-20 -- 19&gt;：      设置checker进程的优先级。
vrrp_no_swap：                      vrrp进程不能够被交换。
checker_no_swap：                   checker进程不能够被交换。

script_user &lt;username&gt; [groupname]：设置运行脚本默认用户和组。如果没有指定，则默认用户为keepalived_script(需要该用户存在)，否则为root用户。默认groupname同username。
enable_script_security：            如果脚本路径的任一部分对于非root用户来说，都具有可写权限，则不会以root身份运行脚本。
nopreempt                           默认是抢占模式 要是用非抢占式的就加上nopreempt

注意：上述为global_defs中的指令
</code></pre><h3 id="VRRPD配置"><a href="#VRRPD配置" class="headerlink" title="VRRPD配置"></a>VRRPD配置</h3><pre><code>VRRPD的配置包括如下子块：
1. vrrp_script
2. vrrp_sync_group
3. garp_group
4. vrrp_instance
</code></pre><h3 id="vrrp-script配置"><a href="#vrrp-script配置" class="headerlink" title="vrrp_script配置"></a>vrrp_script配置</h3><pre><code>作用：添加一个周期性执行的脚本。脚本的退出状态码会被调用它的所有的VRRP Instance记录。
注意：至少有一个VRRP实例调用它并且优先级不能为0.优先级范围是1-254.
vrrp_script &lt;SCRIPT_NAME&gt; {
        ...
    }

选项说明：
scrip &quot;/path/to/somewhere&quot;：指定要执行的脚本的路径。
interval &lt;INTEGER&gt;：指定脚本执行的间隔。单位是秒。默认为1s。
timeout &lt;INTEGER&gt;：指定在多少秒后，脚本被认为执行失败。
weight &lt;-254 --- 254&gt;：调整优先级。默认为2.
rise &lt;INTEGER&gt;：执行成功多少次才认为是成功。
fall &lt;INTEGER&gt;：执行失败多少次才认为失败。
user &lt;USERNAME&gt; [GROUPNAME]：运行脚本的用户和组。
init_fail：假设脚本初始状态是失败状态。

解释：
weight： 
1. 如果脚本执行成功(退出状态码为0)，weight大于0，则priority增加。
2. 如果脚本执行失败(退出状态码为非0)，weight小于0，则priority减少。
3. 其他情况下，priority不变。
</code></pre><h3 id="vrrp-sync-group"><a href="#vrrp-sync-group" class="headerlink" title="vrrp_sync_group"></a>vrrp_sync_group</h3><pre><code>作用：将所有相关的VRRP实例定义在一起，作为一个VRRP Group，如果组内的任意一个实例出现问题，都可以实现Failover。
vrrp_sync_group VG_1 {
    group {
    inside_network     # vrrp instance name
    outside_network    # vrrp instance name
    ...
    }
    ...
}

说明：
如果username和groupname没有指定，则以默认的script_user所指定的用户和组。
1. notify_master /path/to_master.sh [username [groupname]]
    作用：当成为MASTER时，以指定的用户和组执行脚本。
2. notify_backup /path/to_backup.sh [username [groupname]]
    作用：当成为BACKUP时，以指定的用户和组执行脚本。
3. notify_fault &quot;/path/fault.sh VG_1&quot; [username [groupname]]
    作用：当该同步组Fault时，以指定的用户和组执行脚本。
4. notify /path/notify.sh [username [groupname]]
    作用：在任何状态都会以指定的用户和组执行脚本。
    说明：该脚本会在notify_*脚本后执行。
    notify可以使用3个参数，如下：
    $1：可以是GROUP或INTANCE，表明后面是组还是实例。
    $2：组名或实例名。
    $3：转换后的目标状态。有：MASTER、BACKUP、FAULT。

5. smtp_alert：当状态发生改变时，发送邮件。
6. global_tracking：所有的VRRP实例共享相同的tracking配置。

注意：脚本文件要加上x权限，同时指令最好写绝对路径。
</code></pre><h3 id="vrrp-instance"><a href="#vrrp-instance" class="headerlink" title="vrrp_instance"></a>vrrp_instance</h3><pre><code>命令说明：
state MASTER|BACKUP：指定该keepalived节点的初始状态。
interface eth0：vrrp实例绑定的接口，用于发送VRRP包。
use_vmac [&lt;VMAC_INTERFACE&gt;]：在指定的接口产生一个子接口，如vrrp.51，该接口的MAC地址为组播地址，通过该接口向外发送和接收VRRP包。
vmac_xmit_base：通过基本接口向外发送和接收VRRP数据包，而不是通过VMAC接口。
native_ipv6：强制VRRP实例使用IPV6.(当同时配置了IPV4和IPV6的时候)
dont_track_primary：忽略VRRP接口的错误，默认是没有配置的。

track_interface {
eth0
eth1 weight &lt;-254-254&gt;
...
}：如果track的接口有任何一个出现故障，都会进入FAULT状态。

track_script {
&lt;SCRIPT_NAME&gt;
&lt;SCRIPT_NAME&gt; weight &lt;-254-254&gt;
}：添加一个track脚本(vrrp_script配置的脚本。)

mcast_src_ip &lt;IPADDR&gt;：指定发送组播数据包的源IP地址。默认是绑定VRRP实例的接口的主IP地址。
unicast_src_ip &lt;IPADDR&gt;：指定发送单薄数据包的源IP地址。默认是绑定VRRP实例的接口的主IP地址。
version 2|3：指定该实例所使用的VRRP版本。

unicast_peer {
&lt;IPADDR&gt;
...
}：采用单播的方式发送VRRP通告，指定单播邻居的IP地址。

virtual_router_id 51：指定VRRP实例ID，范围是0-255.
priority 100：指定优先级，优先级高的将成为MASTER。
advert_int 1：指定发送VRRP通告的间隔。单位是秒。
authentication {
auth_type PASS|AH：指定认证方式。PASS简单密码认证(推荐),AH:IPSEC认证(不推荐)。
auth_pass 1234：指定认证所使用的密码。最多8位。
}

virtual_ipaddress {
&lt;IPADDR&gt;/&lt;MASK&gt; brd &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPE&gt; label &lt;LABEL&gt;
192.168.200.17/24 dev eth1
192.168.200.18/24 dev eth2 label eth2:1
}：指定VIP地址。

nopreempt：设置为不抢占。默认是抢占的，当高优先级的机器恢复后，会抢占低优先级的机器成为MASTER，而不抢占，则允许低优先级的机器继续成为MASTER，即使高优先级的机器已经上线。如果要使用这个功能，则初始化状态必须为BACKUP。
preempt_delay：设置抢占延迟。单位是秒，范围是0---1000，默认是0.发现低优先级的MASTER后多少秒开始抢占。


通知脚本：
notify_master &lt;STRING&gt;|&lt;QUOTED-STRING&gt; [username [groupname]]
notify_backup &lt;STRING&gt;|&lt;QUOTED-STRING&gt; [username [groupname]]
notify_fault &lt;STRING&gt;|&lt;QUOTED-STRING&gt; [username [groupname]]
notify &lt;STRING&gt;|&lt;QUOTED-STRING&gt; [username [groupname]]

# 当停止VRRP时执行的脚本。
notify_stop &lt;STRING&gt;|&lt;QUOTED-STRING&gt; [username [groupname]]
smtp_alert
</code></pre><h3 id="LVS配置"><a href="#LVS配置" class="headerlink" title="LVS配置"></a>LVS配置</h3><h4 id="virtual-server"><a href="#virtual-server" class="headerlink" title="virtual_server"></a>virtual_server</h4><pre><code>virtual_server IP Port | virtual_server fwmark int | virtual_server group string {
delay_loop &lt;INT&gt;：健康检查的时间间隔。
lb_argo rr|wrr|lc|wlc|lblc|sh|dh：LVS调度算法。
lb_kind NAT|DR|TUN：LVS模式。
persistence_timeout 360：持久化超时时间，单位是秒。默认是6分钟。
persistence_granularity：持久化连接的颗粒度。
protocol TCP|UDP|SCTP：4层协议。
ha_suspend：如果virtual server的IP地址没有设置，则不进行后端服务器的健康检查。
virtualhost &lt;STRING&gt;：为HTTP_GET和SSL_GET执行要检查的虚拟主机。如virtualhost www.felix.com
sorry_server &lt;IPADDR&gt; &lt;PORT&gt;：添加一个备用服务器。当所有的RS都故障时。
sorry_server_inhibit：将inhibit_on_failure指令应用于sorry_server指令。

alpha：在keepalived启动时，假设所有的RS都是down，以及健康检查是失败的。有助于防止启动时的误报。默认是禁用的。
omega：在keepalived终止时，会执行quorum_down指令所定义的脚本。

quorum &lt;INT&gt;：默认值1. 所有的存活的服务器的总的最小权重。
quorum_up &lt;STRING&gt;：当quorum增长到满足quorum所定义的值时，执行该脚本。
quorum_down &lt;STRING&gt;：当quorum减少到不满足quorum所定义的值时，执行该脚本。
}
</code></pre><h4 id="real-server"><a href="#real-server" class="headerlink" title="real_server"></a>real_server</h4><pre><code>real_server IP Port {
weight &lt;INT&gt;：给服务器指定权重。默认是1.
inhibit_on_failure：当服务器健康检查失败时，将其weight设置为0，而不是从Virtual Server中移除。
notify_up &lt;STRING&gt;：当服务器健康检查成功时，执行的脚本。
notify_down &lt;STRING&gt;：当服务器健康检查失败时，执行的脚本。
uthreshold &lt;INT&gt;：到这台服务器的最大连接数。
lthreshold &lt;INT&gt;：到这台服务器的最小连接数。
}
</code></pre><h4 id="real-server中的健康检查"><a href="#real-server中的健康检查" class="headerlink" title="real_server中的健康检查"></a>real_server中的健康检查</h4><pre><code>HTTP_GET | SSL_GET {
url {
path &lt;STRING&gt;：指定要检查的URL的路径。如path / or path /mrtg2
digest &lt;STRING&gt;：摘要。计算方式：genhash -s 172.17.100.1 -p 80 -u /index.html
status_code &lt;INT&gt;：状态码。
}
nb_get_retry &lt;INT&gt;：get尝试次数。
delay_before_retry &lt;INT&gt;：在尝试之前延迟多长时间。

connect_ip &lt;IP ADDRESS&gt;：连接的IP地址。默认是real server的ip地址。
connect_port &lt;PORT&gt;：连接的端口。默认是real server的端口。
bindto &lt;IP ADDRESS&gt;：发起连接的接口的地址。
bind_port &lt;PORT&gt;：发起连接的源端口。
connect_timeout &lt;INT&gt;：连接超时时间。默认是5s。
fwmark &lt;INTEGER&gt;：使用fwmark对所有出去的检查数据包进行标记。
warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。
} 

TCP_CHECK {
connect_ip &lt;IP ADDRESS&gt;：连接的IP地址。默认是real server的ip地址。
connect_port &lt;PORT&gt;：连接的端口。默认是real server的端口。
bindto &lt;IP ADDRESS&gt;：发起连接的接口的地址。
bind_port &lt;PORT&gt;：发起连接的源端口。
connect_timeout &lt;INT&gt;：连接超时时间。默认是5s。
fwmark &lt;INTEGER&gt;：使用fwmark对所有出去的检查数据包进行标记。
warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。
retry &lt;INIT&gt;：重试次数。默认是1次。
delay_before_retry &lt;INT&gt;：默认是1秒。在重试之前延迟多少秒。
}


SMTP_CHECK {
connect_ip &lt;IP ADDRESS&gt;：连接的IP地址。默认是real server的ip地址。
connect_port &lt;PORT&gt;：连接的端口。默认是real server的端口。 默认是25端口
bindto &lt;IP ADDRESS&gt;：发起连接的接口的地址。
bind_port &lt;PORT&gt;：发起连接的源端口。
connect_timeout &lt;INT&gt;：连接超时时间。默认是5s。
fwmark &lt;INTEGER&gt;：使用fwmark对所有出去的检查数据包进行标记。
warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。

retry &lt;INT&gt;：重试次数。
delay_before_retry &lt;INT&gt;：在重试之前延迟多少秒。
helo_name &lt;STRING&gt;：用于SMTP HELO请求的字符串。
}


DNS_CHECK {
connect_ip &lt;IP ADDRESS&gt;：连接的IP地址。默认是real server的ip地址。
connect_port &lt;PORT&gt;：连接的端口。默认是real server的端口。 默认是25端口
bindto &lt;IP ADDRESS&gt;：发起连接的接口的地址。
bind_port &lt;PORT&gt;：发起连接的源端口。
connect_timeout &lt;INT&gt;：连接超时时间。默认是5s。
fwmark &lt;INTEGER&gt;：使用fwmark对所有出去的检查数据包进行标记。
warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。

retry &lt;INT&gt;：重试次数。默认是3次。
type &lt;STRING&gt;：DNS query type。A/NS/CNAME/SOA/MX/TXT/AAAA
name &lt;STRING&gt;：DNS查询的域名。默认是(.)
}



MISC_CHECK {
misc_path &lt;STRING&gt;：外部的脚本或程序路径。
misc_timeout &lt;INT&gt;：脚本执行超时时间。
user USERNAME [GROUPNAME]：指定运行该脚本的用户和组。如果没有指定GROUPNAME，则GROUPNAME同USERNAME。
misc_dynamic：根据退出状态码动态调整权重。
0，健康检查成功，权重不变。
1，健康检查失败。
2-255，健康检查成功。权重设置为退出状态码减去2.如退出状态码是250，则权重调整为248
warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。
}
</code></pre><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><pre><code>global_defs {
    router_id LVS_Server 指定标识该机器的route_id
}
vrrp_instance VI_1 {
    state MASTER 指定该keepalived节点的初始状态
    interface ens8 vrrp实例绑定的接口，用于发送VRRP包
    virtual_router_id 51  指定VRRP实例ID
    priority 150  指定优先级，优先级高的将成为MASTER
    nopreempt   设置为不抢占。默认是抢占的
    advert_int 1   advert_int 1
    authentication {
        auth_type PASS  指定认证方式
        auth_pass password 指定认证所使用的密码。
    }
    virtual_ipaddress {  
        192.168.1.217 dev ens8  指定VIP地址
    }
}
virtual_server 192.168.1.217 443 {
    delay_loop 3  delay_loop
    lvs_sched rr  LVS的调度算法
    lvs_method DR   LVS 模式
    protocol TCP  4层协议
    real_server 192.168.1.211 443 {
        weight 1
        TCP_CHECK {
            connect_port 443
            connect_timeout 3
            nb_get_retry 3  get尝试次数
            delay_before_retry 10  在尝试之前延迟多长时间
        }
    }
    real_server 192.168.1.212 443 {
        weight 1
        TCP_CHECK {
            connect_port 443
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 10
        }
    }
}
virtual_server 192.168.1.217 80 {
    delay_loop 3
    lvs_sched rr
    lvs_method DR
    protocol TCP
    real_server 192.168.1.211 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 10
        }
        }
    }
    real_server 192.168.1.212 80 {
        weight 1  调整优先级。默认为2
        TCP_CHECK {
            connect_port 80   连接的端口
            connect_timeout 3  连接超时时间。默认是5s。
            nb_get_retry 3  get尝试次数。
            delay_before_retry 10
        }
    }
}
</code></pre><h2 id="redis-检测脚本"><a href="#redis-检测脚本" class="headerlink" title="redis 检测脚本"></a>redis 检测脚本</h2><pre><code>check_redis.sh脚本:

#!/bin/sh
CHECK_PROCESS=`ps -C redis-server --no-heading| wc -l`
if [ $CHECK_PROCESS -eq 0 ];then

    echo &quot;Redis is stop&quot;
    sleep 2
    CHECK_PROCESS=`ps -C redis-server --no-heading| wc -l`

    if [ $CHECK_PROCESS -eq 0 ];then
        /etc/init.d/keepalived stop
    fi
fi


check_port.sh脚本

#!/bin/bash

#keepalived 监控端口脚本
#使用方法：
#在keepalived的配置文件中
#vrrp_script check_port 

CHK_PORT=$1
echo $CHK_PORT
if [ &quot;$CHK_PORT&quot; != &quot;&quot; ];then

    PORT_PROCESS=`lsof -i:$CHK_PORT|wc -l`
    if [ $PORT_PROCESS -eq 0 ];then
    echo &quot;Port $CHK_PORT Is Not Used,End.&quot;

    sleep 2
        PORT_PROCESS=`lsof -i:$CHK_PORT|wc -l`
        if [ $PORT_PROCESS -eq 0 ];then
        /etc/init.d/keepalived stop
        fi
    fi
else
    echo &quot;Check Port Cant Be Empty!&quot;
fi
</code></pre><h2 id="进程检测脚本"><a href="#进程检测脚本" class="headerlink" title="进程检测脚本"></a>进程检测脚本</h2><pre><code># vi /etc/keepalived/chk_app.sh
#!/bin/sh

num=`ps -C nginx --no-header |wc -l`

if [ $num -eq 0 ];then
    systmectl restart nginx
sleep 3
    if [ `ps -C nginx --no-header |wc -l` -eq 0 ];then
        systmectl stop keepalived
    fi
fi
</code></pre><h2 id="vrrp-vmac用法："><a href="#vrrp-vmac用法：" class="headerlink" title="vrrp_vmac用法："></a>vrrp_vmac用法：</h2><pre><code>https://github.com/acassen/keepalived/blob/master/doc/NOTE_vrrp_vmac.txt
</code></pre>
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/keepalived/" rel="tag"><i class="fa fa-tag"></i> keepalived</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/oracle/数据库的通用命令行工具 USQL/" rel="next" title="数据库的通用命令行工具 USQL">
                <i class="fa fa-chevron-left"></i> 数据库的通用命令行工具 USQL
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/linux/学习网站/" rel="prev" title="学习网站">
                学习网站 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">dolphin</p>
              <p class="site-description motion-element" itemprop="description">现实是强者理想的实现</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">61</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">46</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#yum-安装"><span class="nav-number">1.</span> <span class="nav-text">yum 安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译安装"><span class="nav-number">2.</span> <span class="nav-text">编译安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开启接口共享IP功能和内核转发功能"><span class="nav-number">3.</span> <span class="nav-text">开启接口共享IP功能和内核转发功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#防火墙配置"><span class="nav-number">4.</span> <span class="nav-text">防火墙配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Haproxy-结合使用问题"><span class="nav-number">5.</span> <span class="nav-text">Haproxy 结合使用问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志设置"><span class="nav-number">6.</span> <span class="nav-text">日志设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#全局配置"><span class="nav-number">7.</span> <span class="nav-text">全局配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#监控检查"><span class="nav-number">8.</span> <span class="nav-text">监控检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#维护检查"><span class="nav-number">9.</span> <span class="nav-text">维护检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#同步组"><span class="nav-number">10.</span> <span class="nav-text">同步组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#虚拟ip配置-vrrp"><span class="nav-number">11.</span> <span class="nav-text">虚拟ip配置 vrrp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置说明"><span class="nav-number">12.</span> <span class="nav-text">配置说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#全局定义模块"><span class="nav-number">12.1.</span> <span class="nav-text">全局定义模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VRRPD配置"><span class="nav-number">12.2.</span> <span class="nav-text">VRRPD配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vrrp-script配置"><span class="nav-number">12.3.</span> <span class="nav-text">vrrp_script配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vrrp-sync-group"><span class="nav-number">12.4.</span> <span class="nav-text">vrrp_sync_group</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vrrp-instance"><span class="nav-number">12.5.</span> <span class="nav-text">vrrp_instance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LVS配置"><span class="nav-number">12.6.</span> <span class="nav-text">LVS配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#virtual-server"><span class="nav-number">12.6.1.</span> <span class="nav-text">virtual_server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#real-server"><span class="nav-number">12.6.2.</span> <span class="nav-text">real_server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#real-server中的健康检查"><span class="nav-number">12.6.3.</span> <span class="nav-text">real_server中的健康检查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实例"><span class="nav-number">12.7.</span> <span class="nav-text">实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-检测脚本"><span class="nav-number">13.</span> <span class="nav-text">redis 检测脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#进程检测脚本"><span class="nav-number">14.</span> <span class="nav-text">进程检测脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vrrp-vmac用法："><span class="nav-number">15.</span> <span class="nav-text">vrrp_vmac用法：</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dolphin</span>

  

  
</div>











        








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
